(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=i(o);fetch(o.href,n)}})();var h=(e=>(e.MOUSE_MOVE="MOUSE_MOVE",e.MOUSE_DOWN="MOUSE_DOWN",e.MOUSE_UP="MOUSE_UP",e.MOUSE_DRAG="MOUSE_DRAG",e.MOUSE_DOUBLE_CLICK="MOUSE_DOUBLE_CLICK",e.KEY_DOWN="KEY_DOWN",e.KEY_UP="KEY_UP",e))(h||{}),b=(e=>(e.SHOW_CURSOR="SHOW_CURSOR",e.HIDE_CURSOR="HIDE_CURSOR",e.UPDATE_BUFFER="UPDATE_BUFFER",e))(b||{});const _=3e3;class B{constructor(t){this.isVisible=!1,this.hideTimeout=null,this.unsubscribe=null,this.mouseService=t,this.handleInputEvent=this.handleInputEvent.bind(this),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.resetHideTimeout=this.resetHideTimeout.bind(this),this.unsubscribe=a.subscribe(this.handleInputEvent,{eventTypes:[h.MOUSE_MOVE,h.MOUSE_DOWN,h.MOUSE_UP,h.MOUSE_DRAG,h.KEY_DOWN,h.KEY_UP]})}handleInputEvent(t){if(this.isInputEvent(t)){if(t.source==="mouse")switch(t.type){case h.MOUSE_MOVE:case h.MOUSE_DRAG:this.show(),this.resetHideTimeout();break;case h.MOUSE_DOWN:this.show(),this.resetHideTimeout();break}else if(t.source==="keyboard"&&t.type===h.KEY_DOWN){const{modifiers:i}=t.data;i.ctrl||i.alt||i.shift||i.meta||(this.cancelHideTimeout(),this.hide())}}}resetHideTimeout(){this.cancelHideTimeout(),this.hideTimeout=setTimeout(()=>{this.hide()},_)}cancelHideTimeout(){this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)}isInputEvent(t){return Object.values(h).includes(t.type)}show(){if(!this.isVisible){this.isVisible=!0;const t=this.mouseService.getState();a.publish({type:b.SHOW_CURSOR,timestamp:Date.now(),priority:50,source:"system",data:{position:t.position}})}}hide(){if(this.isVisible){this.isVisible=!1;const t=this.mouseService.getState();a.publish({type:b.HIDE_CURSOR,timestamp:Date.now(),priority:50,source:"system",data:{position:t.position}})}}cleanup(){this.cancelHideTimeout(),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}}let g=null;function P(e){return g||(g=new B(e)),g}class R{constructor(){this.handlers=new Map,this.priorityThresholds=new Map}subscribe(t,i={}){const{eventTypes:s,minPriority:o=0}=i,n=s||["*"];return n.forEach(r=>{this.handlers.has(r)||this.handlers.set(r,new Set),this.handlers.get(r).add(t),o>0&&this.priorityThresholds.set(r,o)}),()=>{n.forEach(r=>{const l=this.handlers.get(r);l&&(l.delete(t),l.size===0&&(this.handlers.delete(r),this.priorityThresholds.delete(r)))})}}publish(t){t.timestamp||(t.timestamp=Date.now());const i=this.priorityThresholds.get(t.type)||0;if(t.priority>=i){const s=this.handlers.get(t.type);s&&s.forEach(n=>n(t));const o=this.handlers.get("*");o&&o.forEach(n=>n(t))}}clear(){this.handlers.clear(),this.priorityThresholds.clear()}}const a=new R;class T{constructor(){this.state={lastKeyPressed:null,modifiers:{ctrl:!1,alt:!1,shift:!1,meta:!1}},this.listeners=new Set,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this)}initialize(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}cleanup(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(t){this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},this.state.lastKeyPressed=t.key;const i={type:h.KEY_DOWN,timestamp:Date.now(),priority:100,source:"keyboard",data:{key:t.key,modifiers:this.state.modifiers}};a.publish(i),this.notifyListeners()}handleKeyUp(t){this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},this.state.lastKeyPressed===t.key&&(this.state.lastKeyPressed=null);const i={type:h.KEY_UP,timestamp:Date.now(),priority:100,source:"keyboard",data:{key:t.key,modifiers:this.state.modifiers}};a.publish(i),this.notifyListeners()}addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}notifyListeners(){this.listeners.forEach(t=>t(this.state))}getState(){return{...this.state}}}const D=class y{constructor(t,i){this.keyboardService=i,this.element=t,this.state={position:null,isVisible:!1,isButtonDown:!1,modifiers:{ctrl:!1,alt:!1,shift:!1,meta:!1}},this.listeners=new Set,this.lastPosition=null,this.lastClickTime=0,this.lastClickPosition=null,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handleMouseEnter=this.handleMouseEnter.bind(this)}initialize(){this.element.addEventListener("mousemove",this.handleMouseMove),this.element.addEventListener("mousedown",this.handleMouseDown),this.element.addEventListener("mouseup",this.handleMouseUp),this.element.addEventListener("mouseleave",this.handleMouseLeave),this.element.addEventListener("mouseenter",this.handleMouseEnter)}cleanup(){this.element.removeEventListener("mousemove",this.handleMouseMove),this.element.removeEventListener("mousedown",this.handleMouseDown),this.element.removeEventListener("mouseup",this.handleMouseUp),this.element.removeEventListener("mouseleave",this.handleMouseLeave),this.element.removeEventListener("mouseenter",this.handleMouseEnter)}handleMouseEnter(t){const i=this.screenToBuffer(t.clientX,t.clientY);this.state.position=i,this.lastPosition={...i},this.state.isVisible=!0,this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey};const s={type:h.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:i,isButtonDown:this.state.isButtonDown,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};a.publish(s),this.notifyListeners()}handleMouseLeave(t){const i=this.lastPosition?{...this.lastPosition}:null;if(this.state.isVisible=!1,this.state.position=null,this.lastPosition=null,this.state.isButtonDown=!1,i){const s={type:h.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:i,isButtonDown:!1,modifiers:this.state.modifiers,isVisible:!1}};a.publish(s)}this.notifyListeners()}screenToBuffer(t,i){const o=this.element.getBoundingClientRect(),n=t-o.left,r=i-o.top,l=o.width/80,p=o.height/25,S=Math.floor(n/l),U=Math.floor(r/p);return{x:Math.max(0,Math.min(S,79)),y:Math.max(0,Math.min(U,24))}}hasPositionChanged(t,i){return t?t.x!==i.x||t.y!==i.y:!0}handleMouseMove(t){const i=this.element.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;if(s<0||s>=i.width||o<0||o>=i.height){const r=this.lastPosition?{...this.lastPosition}:null;if(this.state.isVisible=!1,this.state.position=null,this.lastPosition=null,this.state.isButtonDown=!1,r){const l={type:h.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:r,isButtonDown:!1,modifiers:this.state.modifiers,isVisible:!1}};a.publish(l)}this.notifyListeners();return}const n=this.screenToBuffer(t.clientX,t.clientY);if(this.hasPositionChanged(this.state.position,n)){this.state.isVisible||(this.state.isVisible=!0),this.state.position=n,this.lastPosition={...n},this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey};const r={type:this.state.isButtonDown?h.MOUSE_DRAG:h.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:n,isButtonDown:this.state.isButtonDown,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};a.publish(r),this.notifyListeners()}}isWithinDoubleClickDistance(t,i){const s=Math.abs(t.x-i.x),o=Math.abs(t.y-i.y);return s<=y.DOUBLE_CLICK_DISTANCE&&o<=y.DOUBLE_CLICK_DISTANCE}handleMouseDown(t){const i=this.element.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;if(s>=0&&s<i.width&&o>=0&&o<i.height){const n=this.screenToBuffer(t.clientX,t.clientY),r=Date.now();this.state.position=n,this.lastPosition={...n},this.state.isButtonDown=!0,this.state.isVisible=!0,this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey};const l={type:h.MOUSE_DOWN,timestamp:r,priority:100,source:"mouse",data:{position:n,isButtonDown:!0,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};if(a.publish(l),this.lastClickPosition&&r-this.lastClickTime<=y.DOUBLE_CLICK_TIMEOUT&&this.isWithinDoubleClickDistance(n,this.lastClickPosition)){const p={type:h.MOUSE_DOUBLE_CLICK,timestamp:r,priority:100,source:"mouse",data:{position:n,isButtonDown:!0,modifiers:{ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},isVisible:!0}};a.publish(p),this.lastClickTime=0,this.lastClickPosition=null}else this.lastClickTime=r,this.lastClickPosition={...n};this.notifyListeners()}}handleMouseUp(t){const i=this.screenToBuffer(t.clientX,t.clientY),s=this.isInBounds(t.clientX,t.clientY);if(this.state.isButtonDown=!1,s&&(this.state.position=i,this.lastPosition={...i},this.state.isVisible=!0),this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},s){const o={type:h.MOUSE_UP,timestamp:Date.now(),priority:100,source:"mouse",data:{position:i,isButtonDown:!1,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};a.publish(o)}this.notifyListeners()}isInBounds(t,i){const s=this.element.getBoundingClientRect(),o=t-s.left,n=i-s.top;return o>=0&&o<s.width&&n>=0&&n<s.height}addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}notifyListeners(){this.listeners.forEach(t=>t(this.state))}getState(){return{...this.state}}};D.DOUBLE_CLICK_TIMEOUT=500;D.DOUBLE_CLICK_DISTANCE=1;let k=D;function v(e,t){const i=new T,s=new k(t,i);return i.initialize(),s.initialize(),{mouse:s,keyboard:i,cleanup:()=>{i.cleanup(),s.cleanup()}}}function x(e,t){return!(e.x+e.width<=t.x||t.x+t.width<=e.x||e.y+e.height<=t.y||t.y+t.height<=e.y)}function V(e,t){const i=Math.min(e.x,t.x),s=Math.min(e.y,t.y),o=Math.max(e.x+e.width,t.x+t.width),n=Math.max(e.y+e.height,t.y+t.height);return{x:i,y:s,width:o-i,height:n-s}}function A(e,t){const i=e.y===t.y&&e.height===t.height&&(e.x+e.width===t.x||t.x+t.width===e.x),s=e.x===t.x&&e.width===t.width&&(e.y+e.height===t.y||t.y+t.height===e.y);return i||s}class I{constructor(t=80,i=25){this.width=t,this.height=i,this.buffer=Array(i).fill(null).map(()=>Array(t).fill(null)),this.cursor={x:0,y:0,visible:!0,blinking:!0},this.dirtyRegions=[],this.batchRegions=[],this.batchMode=!1}writeChar(t,i,s,o){if(t<0||t>=this.width||i<0||i>=this.height)return;const n={char:s[0],attributes:o};this.buffer[i][t]=n,this.markDirty(t,i,1,1)}getChar(t,i){return t<0||t>=this.width||i<0||i>=this.height?null:this.buffer[i][t]}resize(t,i){const s=Array(i).fill(null).map(()=>Array(t).fill(null));for(let o=0;o<Math.min(i,this.height);o++)for(let n=0;n<Math.min(t,this.width);n++)s[o][n]=this.buffer[o][n];this.width=t,this.height=i,this.buffer=s,this.markDirty(0,0,t,i),this.cursor.x=Math.min(this.cursor.x,t-1),this.cursor.y=Math.min(this.cursor.y,i-1)}clear(){for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++)this.buffer[t][i]!==null&&this.markDirty(i,t,1,1);this.buffer=Array(this.height).fill(null).map(()=>Array(this.width).fill(null))}setCursorPosition(t,i){t<0||t>=this.width||i<0||i>=this.height||(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.markDirty(t,i,1,1),this.cursor.x=t,this.cursor.y=i)}getCursorPosition(){return{x:this.cursor.x,y:this.cursor.y}}setCursorVisible(t){this.cursor.visible!==t&&(this.cursor.visible=t,this.markDirty(this.cursor.x,this.cursor.y,1,1))}setCursorBlinking(t){this.cursor.blinking!==t&&(this.cursor.blinking=t,this.markDirty(this.cursor.x,this.cursor.y,1,1))}beginBatch(){this.batchMode=!0,this.batchRegions=[]}endBatch(){this.batchMode=!1,this.batchRegions.length>0&&(this.optimizeAndAddRegions(this.batchRegions),this.batchRegions=[])}flush(){const t=[...this.dirtyRegions];return this.dirtyRegions=[],t}getBufferData(){if(this.cursor.visible&&this.cursor.blinking){const t=performance.now();(!this.cursor.lastBlinkTime||Math.floor(this.cursor.lastBlinkTime/500)!==Math.floor(t/500))&&(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.cursor.lastBlinkTime=t)}return{width:this.width,height:this.height,cells:this.buffer,cursor:{...this.cursor}}}getDirtyRegions(){const t=[...this.dirtyRegions];return this.dirtyRegions=[],t}markDirty(t,i,s,o){const n={x:t,y:i,width:s,height:o};this.batchMode?this.batchRegions.push(n):this.optimizeAndAddRegions([n])}optimizeAndAddRegions(t){let i=[...this.dirtyRegions,...t],s=[],o;do{for(o=!1;i.length>0;){const n=i.pop();let r=!1;for(let l=0;l<s.length;l++)if(x(n,s[l])||A(n,s[l])){s[l]=V(n,s[l]),r=!0,o=!0;break}r||s.push(n)}o&&(i=s,s=[])}while(o);this.dirtyRegions=s}}const O=document.getElementById("demo-area"),f=document.getElementById("mouse-position"),M=document.getElementById("mouse-buttons"),m=document.getElementById("key-pressed"),w=document.getElementById("key-modifiers"),u=document.getElementById("event-log"),E=new I(80,25);O.style.position="relative";const c=document.createElement("canvas"),C=800,H=Math.floor(C/E.getBufferData().width),N=Math.floor(H*1.6),Y=N*E.getBufferData().height;c.width=C;c.height=Y;c.style.position="absolute";c.style.top="0";c.style.left="0";c.style.width="100%";c.style.height="100%";c.style.backgroundColor="transparent";O.appendChild(c);const d=v(E,c);function W(e){const t=document.createElement("div");t.className=`event ${e.type.startsWith("MOUSE")||e.type.startsWith("KEY")?"input-event":"ui-event"}`;const i=new Date(e.timestamp).toISOString().split("T")[1].slice(0,-1),s=e.priority.toString().padStart(3,"0");for(t.textContent=`[${i}] (${s}) ${e.type}: ${JSON.stringify(e.data)}`,u.appendChild(t),u.scrollTop=u.scrollHeight;u.children.length>100;)u.removeChild(u.firstChild)}function K(e=d.mouse.getState()){e.position?(f.textContent=`Position: (${e.position.x}, ${e.position.y})`,f.classList.add("highlight")):(f.textContent="Position: Outside demo area",f.classList.remove("highlight")),M.textContent=`Button: ${e.isButtonDown?"Pressed":"Released"}`,e.isButtonDown?M.classList.add("highlight"):M.classList.remove("highlight")}function L(e=d.keyboard.getState()){e.lastKeyPressed?(m.textContent=`Last Key: ${e.lastKeyPressed}`,m.classList.add("highlight")):(m.textContent="Last Key: None",m.classList.remove("highlight"));const t=[];e.modifiers.ctrl&&t.push("Ctrl"),e.modifiers.alt&&t.push("Alt"),e.modifiers.shift&&t.push("Shift"),e.modifiers.meta&&t.push("⌘"),w.textContent=`Modifiers: ${t.length?t.join(" + "):"None"}`,t.length?w.classList.add("highlight"):w.classList.remove("highlight")}a.subscribe(e=>{W(e)});d.mouse.addListener(e=>K(e));d.keyboard.addListener(e=>L(e));K();L();const z=P(d.mouse);window.addEventListener("unload",()=>{d.cleanup(),z.cleanup()});
