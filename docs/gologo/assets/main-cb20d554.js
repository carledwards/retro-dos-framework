(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();function at(o,t){return!(o.x+o.width<=t.x||t.x+t.width<=o.x||o.y+o.height<=t.y||t.y+t.height<=o.y)}function lt(o,t){const e=Math.min(o.x,t.x),s=Math.min(o.y,t.y),i=Math.max(o.x+o.width,t.x+t.width),r=Math.max(o.y+o.height,t.y+t.height);return{x:e,y:s,width:i-e,height:r-s}}function ct(o,t){const e=o.y===t.y&&o.height===t.height&&(o.x+o.width===t.x||t.x+t.width===o.x),s=o.x===t.x&&o.width===t.width&&(o.y+o.height===t.y||t.y+t.height===o.y);return e||s}class ft{constructor(t=80,e=25){this.width=t,this.height=e,this.buffer=Array(e).fill(null).map(()=>Array(t).fill(null)),this.cursor={x:0,y:0,visible:!0,blinking:!0},this.dirtyRegions=[],this.batchRegions=[],this.batchMode=!1}writeChar(t,e,s,i){if(t<0||t>=this.width||e<0||e>=this.height)return;const r={char:s[0],attributes:i};this.buffer[e][t]=r,this.markDirty(t,e,1,1)}getChar(t,e){return t<0||t>=this.width||e<0||e>=this.height?null:this.buffer[e][t]}resize(t,e){const s=Array(e).fill(null).map(()=>Array(t).fill(null));for(let i=0;i<Math.min(e,this.height);i++)for(let r=0;r<Math.min(t,this.width);r++)s[i][r]=this.buffer[i][r];this.width=t,this.height=e,this.buffer=s,this.markDirty(0,0,t,e),this.cursor.x=Math.min(this.cursor.x,t-1),this.cursor.y=Math.min(this.cursor.y,e-1)}clear(){for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)this.buffer[t][e]!==null&&this.markDirty(e,t,1,1);this.buffer=Array(this.height).fill(null).map(()=>Array(this.width).fill(null))}setCursorPosition(t,e){t<0||t>=this.width||e<0||e>=this.height||(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.markDirty(t,e,1,1),this.cursor.x=t,this.cursor.y=e)}getCursorPosition(){return{x:this.cursor.x,y:this.cursor.y}}setCursorVisible(t){this.cursor.visible!==t&&(this.cursor.visible=t,this.markDirty(this.cursor.x,this.cursor.y,1,1))}setCursorBlinking(t){this.cursor.blinking!==t&&(this.cursor.blinking=t,this.markDirty(this.cursor.x,this.cursor.y,1,1))}beginBatch(){this.batchMode=!0,this.batchRegions=[]}endBatch(){this.batchMode=!1,this.batchRegions.length>0&&(this.optimizeAndAddRegions(this.batchRegions),this.batchRegions=[])}flush(){const t=[...this.dirtyRegions];return this.dirtyRegions=[],t}getBufferData(){if(this.cursor.visible&&this.cursor.blinking){const t=performance.now();(!this.cursor.lastBlinkTime||Math.floor(this.cursor.lastBlinkTime/500)!==Math.floor(t/500))&&(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.cursor.lastBlinkTime=t)}return{width:this.width,height:this.height,cells:this.buffer,cursor:{...this.cursor}}}getDirtyRegions(){const t=[...this.dirtyRegions];return this.dirtyRegions=[],t}markDirty(t,e,s,i){const r={x:t,y:e,width:s,height:i};this.batchMode?this.batchRegions.push(r):this.optimizeAndAddRegions([r])}optimizeAndAddRegions(t){let e=[...this.dirtyRegions,...t],s=[],i;do{for(i=!1;e.length>0;){const r=e.pop();let n=!1;for(let h=0;h<s.length;h++)if(at(r,s[h])||ct(r,s[h])){s[h]=lt(r,s[h]),n=!0,i=!0;break}n||s.push(r)}i&&(e=s,s=[])}while(i);this.dirtyRegions=s}}var Y=(o=>(o.MOUSE_MOVE="MOUSE_MOVE",o.MOUSE_DOWN="MOUSE_DOWN",o.MOUSE_UP="MOUSE_UP",o.MOUSE_DRAG="MOUSE_DRAG",o.MOUSE_DOUBLE_CLICK="MOUSE_DOUBLE_CLICK",o.KEY_DOWN="KEY_DOWN",o.KEY_UP="KEY_UP",o))(Y||{});class dt{constructor(){this.handlers=new Map,this.priorityThresholds=new Map}subscribe(t,e={}){const{eventTypes:s,minPriority:i=0}=e,r=s||["*"];return r.forEach(n=>{this.handlers.has(n)||this.handlers.set(n,new Set),this.handlers.get(n).add(t),i>0&&this.priorityThresholds.set(n,i)}),()=>{r.forEach(n=>{const h=this.handlers.get(n);h&&(h.delete(t),h.size===0&&(this.handlers.delete(n),this.priorityThresholds.delete(n)))})}}publish(t){t.timestamp||(t.timestamp=Date.now());const e=this.priorityThresholds.get(t.type)||0;if(t.priority>=e){const s=this.handlers.get(t.type);s&&s.forEach(r=>r(t));const i=this.handlers.get("*");i&&i.forEach(r=>r(t))}}clear(){this.handlers.clear(),this.priorityThresholds.clear()}}const X=new dt;class ut{constructor(){this.state={lastKeyPressed:null,modifiers:{ctrl:!1,alt:!1,shift:!1,meta:!1}},this.listeners=new Set,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this)}initialize(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}cleanup(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(t){this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},this.state.lastKeyPressed=t.key;const e={type:Y.KEY_DOWN,timestamp:Date.now(),priority:100,source:"keyboard",data:{key:t.key,modifiers:this.state.modifiers}};X.publish(e),this.notifyListeners()}handleKeyUp(t){this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},this.state.lastKeyPressed===t.key&&(this.state.lastKeyPressed=null);const e={type:Y.KEY_UP,timestamp:Date.now(),priority:100,source:"keyboard",data:{key:t.key,modifiers:this.state.modifiers}};X.publish(e),this.notifyListeners()}addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}notifyListeners(){this.listeners.forEach(t=>t(this.state))}getState(){return{...this.state}}}const f={BLACK:0,BLUE:1,GREEN:2,CYAN:3,RED:4,MAGENTA:5,BROWN:6,LIGHT_GRAY:7,DARK_GRAY:8,LIGHT_BLUE:9,LIGHT_GREEN:10,LIGHT_CYAN:11,LIGHT_RED:12,LIGHT_MAGENTA:13,YELLOW:14,WHITE:15};class gt{constructor(t){this.sprites=[],this.groups=new Map,this.collisionHandlers=new Map,this.taggedSprites=new Map,this.currentLevel=1,this.isGameOver=!1,this.buffer=t.buffer,this.borderUI=t.borderUI,this.levelConfig=t.levelConfig,this.gameOverConfig=t.gameOverConfig||{text:"GAME OVER",color:f.YELLOW,backgroundColor:f.BLACK,verticalPosition:.4},t.title&&this.borderUI&&this.borderUI.setTitle(t.title,t.titleAttrs);const{width:e,height:s}=this.buffer.getBufferData();this.borderUI?this.bounds={left:1,right:e-2,top:this.borderUI.config.headerHeight||2,bottom:s-2}:this.bounds=t.bounds??{left:0,right:e-1,top:0,bottom:s-1}}addSprite(t){this.sprites.push(t),this.taggedSprites.has(t.tag)||this.taggedSprites.set(t.tag,new Set),this.taggedSprites.get(t.tag).add(t)}removeSprite(t){const e=this.sprites.indexOf(t);if(e!==-1){this.sprites.splice(e,1);const s=this.taggedSprites.get(t.tag);s&&(s.delete(t),s.size===0&&this.taggedSprites.delete(t.tag)),this.groups.forEach(i=>{const r=i.sprites.indexOf(t);r!==-1&&i.sprites.splice(r,1)})}}createGroup(t){const e={name:t,sprites:[],active:!0};return this.groups.set(t,e),e}addToGroup(t,e){const s=this.groups.get(t);s&&!s.sprites.includes(e)&&s.sprites.push(e)}removeFromGroup(t,e){const s=this.groups.get(t);if(s){const i=s.sprites.indexOf(e);i!==-1&&s.sprites.splice(i,1)}}setGroupVelocity(t,e,s){const i=this.groups.get(t);i&&(i.velocity={x:e,y:s},i.sprites.forEach(r=>r.setVelocity(e,s)))}setGroupAcceleration(t,e,s){const i=this.groups.get(t);i&&(i.acceleration={x:e,y:s},i.sprites.forEach(r=>r.setAcceleration(e,s)))}onCollision(t,e,s){this.collisionHandlers.set(`${t}:${e}`,s),this.collisionHandlers.set(`${e}:${t}`,(i,r)=>s(r,i))}setGameOver(t){this.isGameOver=t}update(t){var s;this.getSpritesWithTag("enemy").length===0&&((s=this.levelConfig)!=null&&s.onLevelComplete)&&(this.currentLevel++,this.levelConfig.onLevelComplete()),this.groups.forEach(i=>{i.active&&i.sprites.forEach(r=>{var n;if(r.active){if(i.velocity){const h=((n=this.levelConfig)==null?void 0:n.speedMultiplier)??1,d=1+(this.currentLevel-1)*h;r.setVelocity(i.velocity.x*d,i.velocity.y*d)}i.acceleration&&r.setAcceleration(i.acceleration.x,i.acceleration.y)}})}),this.sprites.forEach(i=>{i.active&&(i.update(t),i.x=Math.max(this.bounds.left,Math.min(this.bounds.right,i.x)),i.y=Math.max(this.bounds.top,Math.min(this.bounds.bottom,i.y)))}),this.collisionHandlers.forEach((i,r)=>{const[n,h]=r.split(":"),d=this.taggedSprites.get(n),a=this.taggedSprites.get(h);d&&a&&d.forEach(w=>{!w.active||!w.collisionEnabled||a.forEach(E=>{w===E||!E.active||!E.collisionEnabled||w.collidesWith(E)&&i(w,E)})})})}writeChar(t,e,s,i,r){const n={foreground:i,background:r,blink:!1};if(typeof s=="string")for(let h=0;h<s.length;h++)this.buffer.writeChar(t+h,e,s[h],n)}setBorderCell(t,e,s){if(!this.borderUI)return;const i=`setCell${t}`;typeof this.borderUI[i]=="function"&&this.borderUI[i](e,s)}draw(){if(this.buffer.clear(),this.buffer.beginBatch(),this.sprites.forEach(t=>{if(t.active){const e=Math.round(t.x),s=Math.round(t.y);e>=this.bounds.left&&e<=this.bounds.right&&s>=this.bounds.top&&s<=this.bounds.bottom&&this.buffer.writeChar(e,s,t.char,t.getCellAttributes())}}),this.borderUI&&this.borderUI.draw(),this.isGameOver&&this.gameOverConfig){const{text:t,color:e,backgroundColor:s,verticalPosition:i}=this.gameOverConfig,r=Math.floor((this.buffer.getBufferData().width-t.length)/2),n=Math.floor(this.buffer.getBufferData().height*(i||.4));this.writeChar(r,n,t,e||f.YELLOW,s||f.BLACK)}this.buffer.endBatch()}clear(){this.sprites=[],this.groups.clear(),this.collisionHandlers.clear(),this.taggedSprites.clear()}getSpritesWithTag(t){return Array.from(this.taggedSprites.get(t)||[])}getGroup(t){return this.groups.get(t)}}class G{constructor(t){this.x=t.x,this.y=t.y,this.lastX=t.x,this.lastY=t.y,this.char=t.char,this.foreground=t.foreground,this.background=t.background,this.active=t.active??!0,this.collisionEnabled=t.collisionEnabled??!0,this.velocity=t.velocity??{x:0,y:0},this.acceleration=t.acceleration??{x:0,y:0},this.maxSpeed=t.maxSpeed??1/0,this.tag=t.tag??"sprite"}update(t){if(this.active){if(this.lastX=this.x,this.lastY=this.y,this.velocity.x+=this.acceleration.x*t,this.velocity.y+=this.acceleration.y*t,this.maxSpeed!==1/0){const e=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(e>this.maxSpeed){const s=this.maxSpeed/e;this.velocity.x*=s,this.velocity.y*=s}}this.x+=this.velocity.x*t,this.y+=this.velocity.y*t}}setVelocity(t,e){this.velocity.x=t,this.velocity.y=e}setAcceleration(t,e){this.acceleration.x=t,this.acceleration.y=e}stop(){this.velocity.x=0,this.velocity.y=0,this.acceleration.x=0,this.acceleration.y=0}collidesWith(t){if(!this.active||!t.active||!this.collisionEnabled||!t.collisionEnabled)return!1;const e=Math.round(this.x),s=Math.round(this.y),i=Math.round(t.x),r=Math.round(t.y);return Math.abs(e-i)<=1&&Math.abs(s-r)<=1}getCellAttributes(){return{foreground:this.foreground,background:this.background,blink:!1}}}class yt{constructor(){this.paths=new Map}addSprite(t,e){this.paths.set(t,{path:e,time:0,complete:!1,startX:t.x,startY:t.y})}removeSprite(t){this.paths.delete(t)}isComplete(t){const e=this.paths.get(t);return e?e.complete:!0}update(t){this.paths.forEach((e,s)=>{if(e.complete&&!e.path.loop)return;e.time+=t*e.path.speed;const i=e.path.points.length-1,r=e.path.loop?e.time%i:Math.min(e.time,i),n=Math.floor(r),h=r-n;if(n<i){const d=e.path.points[n],a=e.path.points[n+1];s.x=e.startX+d.x+(a.x-d.x)*h,s.y=e.startY+d.y+(a.y-d.y)*h}!e.path.loop&&r>=i&&(e.complete=!0)})}getDirection(t){const e=this.paths.get(t);if(!e||e.complete)return null;const s=e.path.points.length-1,i=Math.min(e.time,s),r=Math.floor(i);if(r<s){const n=e.path.points[r],h=e.path.points[r+1];return{dx:h.x-n.x,dy:h.y-n.y}}return null}}class pt{constructor(t,e){this.titleText="",this.cell1Text="",this.cell2Text="",this.cell3Text="",this.buffer=t,this.config={headerHeight:3,backgroundColor:0,...e},this.calculateHeaderAreas()}calculateHeaderAreas(){const{width:t}=this.config,e=t-4,s=Math.floor(e/3),i=0,r=s+1,n=s*2+2;this.config.columnPositions=[i,r,n,t-1];const h=r+3,a=n-2-h;this.config.areas={title:{x:h,y:0,width:a,maxWidth:a},cell1:{x:i+2,y:2,width:r-i-3,maxWidth:r-i-3},cell2:{x:r+2,y:2,width:n-r-3,maxWidth:n-r-3},cell3:{x:n+2,y:2,width:t-n-3,maxWidth:t-n-3}}}draw(){const{width:t,height:e,headerHeight:s,color:i,backgroundColor:r,columnPositions:n}=this.config,h={foreground:i,background:r,blink:!1};this.drawBorderStructure(h),this.drawTextContent(h)}drawBorderStructure(t){const e={...t,foreground:this.config.color??t.foreground};this.drawBaseStructure(e),this.drawSwoop(e),this.drawTitleArea(e)}drawTextContent(t){if(!this.config.areas)return;const e=this.config.areas;if(this.titleText){const s=e.title.x+Math.floor((e.title.width-this.titleText.length)/2);this.drawHeader(this.titleText,s,e.title.y,{foreground:f.YELLOW,background:this.config.backgroundColor,blink:!1})}this.cell1Text&&this.cell1Attrs&&this.drawHeader(this.cell1Text.substring(0,e.cell1.width),e.cell1.x,e.cell1.y,this.cell1Attrs),this.cell2Text&&this.cell2Attrs&&this.drawHeader(this.cell2Text.substring(0,e.cell2.width),e.cell2.x,e.cell2.y,this.cell2Attrs),this.cell3Text&&this.cell3Attrs&&this.drawHeader(this.cell3Text.substring(0,e.cell3.width),e.cell3.x,e.cell3.y,this.cell3Attrs)}drawBaseStructure(t){const{width:e,height:s,headerHeight:i,columnPositions:r}=this.config;if(!r)return;const[n,h,d]=r;for(let a=2;a<i;a++)this.writeChar(0,a,"║",t),this.writeChar(h,a,"║",t),this.writeChar(d,a,"║",t),this.writeChar(e-1,a,"║",t);this.writeChar(0,i,"╟",t),this.writeChar(h,i,"╨",t),this.writeChar(d,i,"╨",t),this.writeChar(e-1,i,"╢",t);for(let a=1;a<e-1;a++)a!==h&&a!==d&&this.writeChar(a,i,"─",t);for(let a=i+1;a<s-1;a++)this.writeChar(0,a,"║",t),this.writeChar(e-1,a,"║",t);this.writeChar(0,s-1,"╚",t),this.writeChar(e-1,s-1,"╝",t);for(let a=1;a<e-1;a++)this.writeChar(a,s-1,"═",t)}drawSwoop(t){const{width:e}=this.config;this.writeChar(0,0,"╔",t),this.writeChar(1,0,"╔",t),this.writeChar(e-2,0,"╗",t),this.writeChar(e-1,0,"╗",t);for(let s=2;s<e-2;s++)this.writeChar(s,0,"═",t);this.writeChar(0,1,"║",t),this.writeChar(1,1,"╚",t),this.writeChar(e-2,1,"╝",t),this.writeChar(e-1,1,"║",t);for(let s=2;s<e-2;s++)this.writeChar(s,1,"═",t)}drawTitleArea(t){const{columnPositions:e}=this.config;if(!e)return;const[,s,i]=e;this.writeChar(s,0,"╦",t),this.writeChar(s+1,0,"═",t),this.writeChar(s+2,0,"╡",t),this.writeChar(i-2,0,"╞",t),this.writeChar(i-1,0,"═",t),this.writeChar(i,0,"╦",t)}drawInfoCells(t){}writeChar(t,e,s,i){this.buffer.writeChar(t,e,s,i)}drawHeader(t,e,s,i){this.buffer.beginBatch();for(let r=0;r<t.length;r++)this.buffer.writeChar(e+r,s,t[r],i);this.buffer.endBatch()}drawCentered(t,e,s){const i=Math.floor((this.config.width-t.length)/2);this.drawHeader(t,i,e,s)}setTitle(t,e){if(!this.config.areas)return;this.titleText=t;const s=this.config.areas.title,i={foreground:(e==null?void 0:e.foreground)??this.config.color,background:this.config.backgroundColor,blink:!1};for(let n=s.x;n<s.x+s.width;n++)this.writeChar(n,s.y," ",i);const r=s.x+Math.floor((s.width-t.length)/2);this.drawHeader(t,r,s.y,i)}setCell1(t,e){if(!this.config.areas)return;this.cell1Text=t,this.cell1Attrs=e?{...e}:{foreground:this.config.color,background:this.config.backgroundColor,blink:!1};const s=this.config.areas.cell1;this.drawHeader(t.substring(0,s.width),s.x,s.y,this.cell1Attrs)}setCell2(t,e){if(!this.config.areas)return;this.cell2Text=t,this.cell2Attrs=e?{...e}:{foreground:this.config.color,background:this.config.backgroundColor,blink:!1};const s=this.config.areas.cell2;this.drawHeader(t.substring(0,s.width),s.x,s.y,this.cell2Attrs)}setCell3(t,e){if(!this.config.areas)return;this.cell3Text=t,this.cell3Attrs=e?{...e}:{foreground:this.config.color,background:this.config.backgroundColor,blink:!1};const s=this.config.areas.cell3;this.drawHeader(t.substring(0,s.width),s.x,s.y,this.cell3Attrs)}getAreas(){return this.config.areas}}const p=60,g=50,$=9,q=16,j=30,mt=2,xt=1.5,J=15,Q=15,u=2,y=1,P=p-2,wt=.002,bt=1,Ct=12,Et=.01,At=.05,St=15,D=document.getElementById("screen");D.width=p*$;D.height=g*q;const O=D.getContext("2d"),W=new ft(p,g),B=new yt,Lt=new pt(W,{width:p,height:g,backgroundColor:f.BLACK,color:f.LIGHT_CYAN}),A=new ut;A.initialize();const Mt=[[{x:0,y:0},{x:-10,y:5},{x:-20,y:15},{x:-25,y:25},{x:-15,y:35},{x:0,y:35},{x:15,y:25},{x:20,y:15},{x:10,y:5},{x:0,y:0}],[{x:0,y:0},{x:10,y:5},{x:20,y:15},{x:25,y:25},{x:15,y:35},{x:0,y:35},{x:-15,y:25},{x:-20,y:15},{x:-10,y:5},{x:0,y:0}],[{x:0,y:0},{x:0,y:10},{x:0,y:25},{x:0,y:35},{x:15,y:25},{x:-15,y:15},{x:15,y:5},{x:0,y:0}]],K={UP:"Λ",DOWN:"V",LEFT:"<",RIGHT:">"};function C(o){return o=Math.max(y,Math.min(P,o)),Math.round((o-y)/u)*u+y}const Z=[];for(let o=0;o<100;o++){const t=Math.floor(Math.random()*(p-4))+2,e=Math.floor(Math.random()*(g-7))+5;Z.push(new G({x:t,y:e,char:Math.random()<.3?"·":Math.random()<.6?".":"·",foreground:Math.random()<.7?f.DARK_GRAY:f.LIGHT_GRAY,background:f.BLACK,tag:"star"}))}let l,c,U,V,k,R=!1,x=!1,b=0,S=3,L=0,_=0,N=1,M=new Map;const z=Mt.map(o=>({points:o,speed:xt,loop:!1}));function F(o){o.createGroup("enemies");const t=3,e=6,s=u*3,i=3;for(let r=0;r<t;r++)for(let n=0;n<e;n++){const h=y+8+n*s,d=7+r*i,a=new G({x:h,y:d,char:"V",foreground:f.LIGHT_RED,background:f.BLACK,tag:"enemy"});o.addSprite(a),o.addToGroup("enemies",a),M.set(a,{sprite:a,isAttacking:!1,formationX:h,formationY:d})}o.setGroupVelocity("enemies",mt,0)}function tt(){M=new Map,N=1,l=new gt({buffer:W,borderUI:Lt,title:"G O L O G O",titleAttrs:{foreground:f.YELLOW,background:f.BLACK,blink:!1},levelConfig:{speedMultiplier:.2,onLevelComplete:()=>{N++,F(l),H()}},gameOverConfig:{text:"GAME OVER - PRESS R TO PLAY AGAIN",color:f.YELLOW,backgroundColor:f.BLACK,verticalPosition:.4}}),Z.forEach(o=>l.addSprite(o)),c=new G({x:C(Math.floor(p/2)),y:g-3,char:"^",foreground:f.LIGHT_GREEN,background:f.BLACK,tag:"player"}),l.addSprite(c),F(l),l.onCollision("bullet","enemy",(o,t)=>{l.removeSprite(o),l.removeSprite(t),M.delete(t),x||(U+=100,H())}),l.onCollision("bullet","enemyBullet",(o,t)=>{l.removeSprite(o),l.removeSprite(t)}),l.onCollision("player","enemy",(o,t)=>{b===0&&(l.removeSprite(t),M.delete(t),b=30,x||(S--,H(),S<=0&&(R=!0,x=!0,l.setGameOver(!0),o.x=C(Math.floor(p/2)),o.y=g-3)))}),l.onCollision("player","enemyBullet",(o,t)=>{b===0&&(l.removeSprite(t),b=30,x||(S--,H(),S<=0&&(R=!0,x=!0,l.setGameOver(!0),o.x=C(Math.floor(p/2)),o.y=g-3)))}),U=0,R=!1,S=3,b=0,L=0,H()}function et(o){k||(k=o);const t=(o-k)/1e3;if(k=o,L>0&&L--,b>0?(b--,b%4<2?(c.char="*",c.foreground=f.YELLOW):(c.char="^",c.foreground=f.LIGHT_GREEN)):c.char!=="^"&&(c.char="^",c.foreground=f.LIGHT_GREEN),_>0&&_--,!R){const i=A.getState();if(L===0){const r=i.lastKeyPressed==="ArrowLeft"?c.x-u:i.lastKeyPressed==="ArrowRight"?c.x+u:c.x;(i.lastKeyPressed==="ArrowLeft"||i.lastKeyPressed==="ArrowRight")&&r>=y&&r<=P&&(c.x=C(r),L=J,A.cleanup(),A.initialize())}if(i.lastKeyPressed===" "&&_===0&&l.getSpritesWithTag("bullet").length<3){const n=new G({x:c.x,y:c.y-1,char:"*",foreground:f.WHITE,background:f.BLACK,tag:"bullet"});n.setVelocity(0,-j),l.addSprite(n),_=Q,A.cleanup(),A.initialize()}}x&&_t(),l.getSpritesWithTag("enemy").forEach(i=>{const r=M.get(i);if(r.isAttacking){const n=B.getDirection(i);if(n){Math.abs(n.dx)>Math.abs(n.dy)?i.char=n.dx>0?K.RIGHT:K.LEFT:i.char=n.dy>0?K.DOWN:K.UP;const d=Math.abs(i.y-c.y)<St?At:Et;if(Math.random()<d){const a=new G({x:i.x,y:i.y+1,char:".",foreground:f.LIGHT_RED,background:f.BLACK,tag:"enemyBullet"});a.setVelocity(0,Ct),l.addSprite(a)}}else if(B.isComplete(i)){r.isAttacking=!1;const h=l.getGroup("enemies");if(h&&h.sprites.length>0){const d=h.sprites[0],a=M.get(d),w=d.x-a.formationX,E=3,it=6,st=u*3,rt=3,ot=y+8,nt=7,T=[];for(let m=0;m<E;m++)for(let v=0;v<it;v++){const I=ot+v*st+w,ht=nt+m*rt;T.push({x:I,y:ht})}if(h.sprites.forEach(m=>{const v=T.findIndex(I=>I.x===m.x&&I.y===m.y);v!==-1&&T.splice(v,1)}),T.length>0){const m=T[Math.floor(Math.random()*T.length)];i.x=m.x,i.y=m.y}else i.x=r.formationX+w,i.y=r.formationY}else i.x=r.formationX,i.y=r.formationY;i.char=K.DOWN,l.addToGroup("enemies",i),B.removeSprite(i)}}else if(Array.from(M.values()).filter(h=>h.isAttacking).length<bt&&Math.random()<wt){r.isAttacking=!0,l.removeFromGroup("enemies",i);const h=z[Math.floor(Math.random()*z.length)];B.addSprite(i,h)}});const s=l.getGroup("enemies");if(s&&s.sprites.length>0){const i=Math.min(...s.sprites.map(h=>h.x)),r=Math.max(...s.sprites.map(h=>h.x));if(Math.max(...s.sprites.map(h=>h.y))>=g-5&&(R=!0,x=!0,l.setGameOver(!0),c.x=C(Math.floor(p/2)),c.y=g-3),i<=y||r>=P){const d=Math.abs(s.velocity.x)*1.2;l.setGroupVelocity("enemies",i<=y?d:-d,0),s.sprites.forEach(a=>{a.y+=1})}}B.update(t),l.update(t),l.getSpritesWithTag("bullet").forEach(i=>{i.y<=4&&l.removeSprite(i)}),l.getSpritesWithTag("enemyBullet").forEach(i=>{i.y>=g-3&&l.removeSprite(i)}),["bullet","enemyBullet","enemy"].forEach(i=>{l.getSpritesWithTag(i).forEach(r=>{r.active||l.removeSprite(r)})}),Tt(),V=requestAnimationFrame(et)}function H(){document.getElementById("score").textContent=U.toString(),document.getElementById("lives").textContent=S.toString()}function Tt(){l.setBorderCell(1,`SCORE: ${U.toString().padStart(5,"0")}`,{foreground:f.LIGHT_BLUE,background:f.BLACK,blink:!1}),l.setBorderCell(2,`LEVEL ${N}`,{foreground:f.LIGHT_BLUE,background:f.BLACK,blink:!1}),l.setBorderCell(3,`SHIPS: ${S}`,{foreground:f.LIGHT_BLUE,background:f.BLACK,blink:!1}),l.draw(),vt()}function vt(){const{cells:o}=W.getBufferData();O.fillStyle="#000",O.fillRect(0,0,D.width,D.height);for(let t=0;t<g;t++)for(let e=0;e<p;e++){const s=o[t][e];s&&(O.font="16px monospace",O.textBaseline="top",O.fillStyle=Ot(s.attributes.foreground),O.fillText(s.char,e*$,t*q))}}function Ot(o){return["#000000","#0000aa","#00aa00","#00aaaa","#aa0000","#aa00aa","#aa5500","#aaaaaa","#555555","#5555ff","#55ff55","#55ffff","#ff5555","#ff55ff","#ffff55","#ffffff"][o]}document.addEventListener("keydown",o=>{R&&o.code==="KeyR"&&(x=!1,tt(),k=performance.now())});function kt(){const o=l.getSpritesWithTag("enemy");if(o.length===0)return null;let t=o[0],e=Math.abs(t.x-c.x);return o.forEach(s=>{const i=Math.abs(s.x-c.x);i<e&&(e=i,t=s)}),t}function _t(){if(!x)return;const o=kt();if(o){if(L===0){if(Math.random()<.3){const t=Math.random()<.5?-u:u,e=c.x+t;e>=y&&e<=P&&(c.x=C(e))}else Math.abs(o.x-c.x)>u&&(o.x<c.x&&c.x>y?c.x=C(c.x-u):o.x>c.x&&c.x<P&&(c.x=C(c.x+u)));L=J}if(_===0&&Math.random()<.1&&l.getSpritesWithTag("bullet").length<3){const e=new G({x:c.x,y:c.y-1,char:"*",foreground:f.WHITE,background:f.BLACK,tag:"bullet"});e.setVelocity(0,-j),l.addSprite(e),_=Q*2}}}tt();k=performance.now();V=requestAnimationFrame(et);window.addEventListener("unload",()=>{A.cleanup(),cancelAnimationFrame(V)});
