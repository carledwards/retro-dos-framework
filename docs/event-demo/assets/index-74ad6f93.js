(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=e(o);fetch(o.href,r)}})();var l=(i=>(i.MOUSE_MOVE="MOUSE_MOVE",i.MOUSE_DOWN="MOUSE_DOWN",i.MOUSE_UP="MOUSE_UP",i.MOUSE_DRAG="MOUSE_DRAG",i.MOUSE_DOUBLE_CLICK="MOUSE_DOUBLE_CLICK",i.KEY_DOWN="KEY_DOWN",i.KEY_UP="KEY_UP",i))(l||{}),g=(i=>(i.SHOW_CURSOR="SHOW_CURSOR",i.HIDE_CURSOR="HIDE_CURSOR",i.UPDATE_BUFFER="UPDATE_BUFFER",i))(g||{});function L(i,t){return!(i.x+i.width<=t.x||t.x+t.width<=i.x||i.y+i.height<=t.y||t.y+t.height<=i.y)}function x(i,t){const e=Math.min(i.x,t.x),s=Math.min(i.y,t.y),o=Math.max(i.x+i.width,t.x+t.width),r=Math.max(i.y+i.height,t.y+t.height);return{x:e,y:s,width:o-e,height:r-s}}function F(i,t){const e=i.y===t.y&&i.height===t.height&&(i.x+i.width===t.x||t.x+t.width===i.x),s=i.x===t.x&&i.width===t.width&&(i.y+i.height===t.y||t.y+t.height===i.y);return e||s}class P{constructor(t=80,e=25){this.width=t,this.height=e,this.buffer=Array(e).fill(null).map(()=>Array(t).fill(null)),this.cursor={x:0,y:0,visible:!0,blinking:!0},this.dirtyRegions=[],this.batchRegions=[],this.batchMode=!1}writeChar(t,e,s,o){if(t<0||t>=this.width||e<0||e>=this.height)return;const r={char:s[0],attributes:o};this.buffer[e][t]=r,this.markDirty(t,e,1,1)}getChar(t,e){return t<0||t>=this.width||e<0||e>=this.height?null:this.buffer[e][t]}resize(t,e){const s=Array(e).fill(null).map(()=>Array(t).fill(null));for(let o=0;o<Math.min(e,this.height);o++)for(let r=0;r<Math.min(t,this.width);r++)s[o][r]=this.buffer[o][r];this.width=t,this.height=e,this.buffer=s,this.markDirty(0,0,t,e),this.cursor.x=Math.min(this.cursor.x,t-1),this.cursor.y=Math.min(this.cursor.y,e-1)}clear(){for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)this.buffer[t][e]!==null&&this.markDirty(e,t,1,1);this.buffer=Array(this.height).fill(null).map(()=>Array(this.width).fill(null))}setCursorPosition(t,e){t<0||t>=this.width||e<0||e>=this.height||(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.markDirty(t,e,1,1),this.cursor.x=t,this.cursor.y=e)}getCursorPosition(){return{x:this.cursor.x,y:this.cursor.y}}setCursorVisible(t){this.cursor.visible!==t&&(this.cursor.visible=t,this.markDirty(this.cursor.x,this.cursor.y,1,1))}setCursorBlinking(t){this.cursor.blinking!==t&&(this.cursor.blinking=t,this.markDirty(this.cursor.x,this.cursor.y,1,1))}beginBatch(){this.batchMode=!0,this.batchRegions=[]}endBatch(){this.batchMode=!1,this.batchRegions.length>0&&(this.optimizeAndAddRegions(this.batchRegions),this.batchRegions=[])}flush(){const t=[...this.dirtyRegions];return this.dirtyRegions=[],t}getBufferData(){if(this.cursor.visible&&this.cursor.blinking){const t=performance.now();(!this.cursor.lastBlinkTime||Math.floor(this.cursor.lastBlinkTime/500)!==Math.floor(t/500))&&(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.cursor.lastBlinkTime=t)}return{width:this.width,height:this.height,cells:this.buffer,cursor:{...this.cursor}}}getDirtyRegions(){const t=[...this.dirtyRegions];return this.dirtyRegions=[],t}markDirty(t,e,s,o){const r={x:t,y:e,width:s,height:o};this.batchMode?this.batchRegions.push(r):this.optimizeAndAddRegions([r])}optimizeAndAddRegions(t){let e=[...this.dirtyRegions,...t],s=[],o;do{for(o=!1;e.length>0;){const r=e.pop();let n=!1;for(let h=0;h<s.length;h++)if(L(r,s[h])||F(r,s[h])){s[h]=x(r,s[h]),n=!0,o=!0;break}n||s.push(r)}o&&(e=s,s=[])}while(o);this.dirtyRegions=s}}const T=3e3;class V{constructor(t){this.isVisible=!1,this.hideTimeout=null,this.unsubscribe=null,this.mouseService=t,this.handleInputEvent=this.handleInputEvent.bind(this),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.resetHideTimeout=this.resetHideTimeout.bind(this),this.unsubscribe=a.subscribe(this.handleInputEvent,{eventTypes:[l.MOUSE_MOVE,l.MOUSE_DOWN,l.MOUSE_UP,l.MOUSE_DRAG,l.KEY_DOWN,l.KEY_UP]})}handleInputEvent(t){if(this.isInputEvent(t)){if(t.source==="mouse")switch(t.type){case l.MOUSE_MOVE:case l.MOUSE_DRAG:this.show(),this.resetHideTimeout();break;case l.MOUSE_DOWN:this.show(),this.resetHideTimeout();break}else if(t.source==="keyboard"&&t.type===l.KEY_DOWN){const{modifiers:e}=t.data;e.ctrl||e.alt||e.shift||e.meta||(this.cancelHideTimeout(),this.hide())}}}resetHideTimeout(){this.cancelHideTimeout(),this.hideTimeout=setTimeout(()=>{this.hide()},T)}cancelHideTimeout(){this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)}isInputEvent(t){return Object.values(l).includes(t.type)}show(){if(!this.isVisible){this.isVisible=!0;const t=this.mouseService.getState();a.publish({type:g.SHOW_CURSOR,timestamp:Date.now(),priority:50,source:"system",data:{position:t.position}})}}hide(){if(this.isVisible){this.isVisible=!1;const t=this.mouseService.getState();a.publish({type:g.HIDE_CURSOR,timestamp:Date.now(),priority:50,source:"system",data:{position:t.position}})}}cleanup(){this.cancelHideTimeout(),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}}let S=null;function v(i){return S||(S=new V(i)),S}class I{constructor(){this.handlers=new Map,this.priorityThresholds=new Map}subscribe(t,e={}){const{eventTypes:s,minPriority:o=0}=e,r=s||["*"];return r.forEach(n=>{this.handlers.has(n)||this.handlers.set(n,new Set),this.handlers.get(n).add(t),o>0&&this.priorityThresholds.set(n,o)}),()=>{r.forEach(n=>{const h=this.handlers.get(n);h&&(h.delete(t),h.size===0&&(this.handlers.delete(n),this.priorityThresholds.delete(n)))})}}publish(t){t.timestamp||(t.timestamp=Date.now());const e=this.priorityThresholds.get(t.type)||0;if(t.priority>=e){const s=this.handlers.get(t.type);s&&s.forEach(r=>r(t));const o=this.handlers.get("*");o&&o.forEach(r=>r(t))}}clear(){this.handlers.clear(),this.priorityThresholds.clear()}}const a=new I;class H{constructor(){this.state={lastKeyPressed:null,modifiers:{ctrl:!1,alt:!1,shift:!1,meta:!1}},this.listeners=new Set,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this)}initialize(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}cleanup(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(t){this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},this.state.lastKeyPressed=t.key;const e={type:l.KEY_DOWN,timestamp:Date.now(),priority:100,source:"keyboard",data:{key:t.key,modifiers:this.state.modifiers}};a.publish(e),this.notifyListeners()}handleKeyUp(t){this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},this.state.lastKeyPressed===t.key&&(this.state.lastKeyPressed=null);const e={type:l.KEY_UP,timestamp:Date.now(),priority:100,source:"keyboard",data:{key:t.key,modifiers:this.state.modifiers}};a.publish(e),this.notifyListeners()}addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}notifyListeners(){this.listeners.forEach(t=>t(this.state))}getState(){return{...this.state}}}const O=class M{constructor(t,e){this.keyboardService=e,this.element=t,this.state={position:null,isVisible:!1,isButtonDown:!1,modifiers:{ctrl:!1,alt:!1,shift:!1,meta:!1}},this.listeners=new Set,this.lastPosition=null,this.lastClickTime=0,this.lastClickPosition=null,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleMouseLeave=this.handleMouseLeave.bind(this),this.handleMouseEnter=this.handleMouseEnter.bind(this)}initialize(){this.element.addEventListener("mousemove",this.handleMouseMove),this.element.addEventListener("mousedown",this.handleMouseDown),this.element.addEventListener("mouseup",this.handleMouseUp),this.element.addEventListener("mouseleave",this.handleMouseLeave),this.element.addEventListener("mouseenter",this.handleMouseEnter)}cleanup(){this.element.removeEventListener("mousemove",this.handleMouseMove),this.element.removeEventListener("mousedown",this.handleMouseDown),this.element.removeEventListener("mouseup",this.handleMouseUp),this.element.removeEventListener("mouseleave",this.handleMouseLeave),this.element.removeEventListener("mouseenter",this.handleMouseEnter)}handleMouseEnter(t){const e=this.screenToBuffer(t.clientX,t.clientY);this.state.position=e,this.lastPosition={...e},this.state.isVisible=!0,this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey};const s={type:l.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:e,isButtonDown:this.state.isButtonDown,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};a.publish(s),this.notifyListeners()}handleMouseLeave(t){const e=this.lastPosition?{...this.lastPosition}:null;if(this.state.isVisible=!1,this.state.position=null,this.lastPosition=null,this.state.isButtonDown=!1,e){const s={type:l.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:e,isButtonDown:!1,modifiers:this.state.modifiers,isVisible:!1}};a.publish(s)}this.notifyListeners()}screenToBuffer(t,e){const o=this.element.getBoundingClientRect(),r=t-o.left,n=e-o.top,h=o.width/80,f=o.height/25,y=Math.floor(r/h),b=Math.floor(n/f);return{x:Math.max(0,Math.min(y,79)),y:Math.max(0,Math.min(b,24))}}hasPositionChanged(t,e){return t?t.x!==e.x||t.y!==e.y:!0}handleMouseMove(t){const e=this.element.getBoundingClientRect(),s=t.clientX-e.left,o=t.clientY-e.top;if(s<0||s>=e.width||o<0||o>=e.height){const n=this.lastPosition?{...this.lastPosition}:null;if(this.state.isVisible=!1,this.state.position=null,this.lastPosition=null,this.state.isButtonDown=!1,n){const h={type:l.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:n,isButtonDown:!1,modifiers:this.state.modifiers,isVisible:!1}};a.publish(h)}this.notifyListeners();return}const r=this.screenToBuffer(t.clientX,t.clientY);if(this.hasPositionChanged(this.state.position,r)){this.state.isVisible||(this.state.isVisible=!0),this.state.position=r,this.lastPosition={...r},this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey};const n={type:this.state.isButtonDown?l.MOUSE_DRAG:l.MOUSE_MOVE,timestamp:Date.now(),priority:100,source:"mouse",data:{position:r,isButtonDown:this.state.isButtonDown,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};a.publish(n),this.notifyListeners()}}isWithinDoubleClickDistance(t,e){const s=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y);return s<=M.DOUBLE_CLICK_DISTANCE&&o<=M.DOUBLE_CLICK_DISTANCE}handleMouseDown(t){const e=this.element.getBoundingClientRect(),s=t.clientX-e.left,o=t.clientY-e.top;if(s>=0&&s<e.width&&o>=0&&o<e.height){const r=this.screenToBuffer(t.clientX,t.clientY),n=Date.now();this.state.position=r,this.lastPosition={...r},this.state.isButtonDown=!0,this.state.isVisible=!0,this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey};const h={type:l.MOUSE_DOWN,timestamp:n,priority:100,source:"mouse",data:{position:r,isButtonDown:!0,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};if(a.publish(h),this.lastClickPosition&&n-this.lastClickTime<=M.DOUBLE_CLICK_TIMEOUT&&this.isWithinDoubleClickDistance(r,this.lastClickPosition)){const f={type:l.MOUSE_DOUBLE_CLICK,timestamp:n,priority:100,source:"mouse",data:{position:r,isButtonDown:!0,modifiers:{ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},isVisible:!0}};a.publish(f),this.lastClickTime=0,this.lastClickPosition=null}else this.lastClickTime=n,this.lastClickPosition={...r};this.notifyListeners()}}handleMouseUp(t){const e=this.screenToBuffer(t.clientX,t.clientY),s=this.isInBounds(t.clientX,t.clientY);if(this.state.isButtonDown=!1,s&&(this.state.position=e,this.lastPosition={...e},this.state.isVisible=!0),this.state.modifiers={ctrl:t.ctrlKey,alt:t.altKey,shift:t.shiftKey,meta:t.metaKey},s){const o={type:l.MOUSE_UP,timestamp:Date.now(),priority:100,source:"mouse",data:{position:e,isButtonDown:!1,modifiers:this.state.modifiers,isVisible:this.state.isVisible}};a.publish(o)}this.notifyListeners()}isInBounds(t,e){const s=this.element.getBoundingClientRect(),o=t-s.left,r=e-s.top;return o>=0&&o<s.width&&r>=0&&r<s.height}addListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}notifyListeners(){this.listeners.forEach(t=>t(this.state))}getState(){return{...this.state}}};O.DOUBLE_CLICK_TIMEOUT=500;O.DOUBLE_CLICK_DISTANCE=1;let N=O;function W(i,t){const e=new H,s=new N(t,e);return e.initialize(),s.initialize(),{mouse:s,keyboard:e,cleanup:()=>{e.cleanup(),s.cleanup()}}}const c=new P(80,25),Y=document.getElementById("buffer"),$=document.getElementById("status"),p=document.getElementById("event-log"),z=1.6,k=800,X=Math.floor(k/c.getBufferData().width),G=Math.floor(X*z),j=G*c.getBufferData().height,d=document.createElement("canvas");d.width=k;d.height=j;d.style.border="1px solid #333";d.style.backgroundColor="#000";d.style.display="block";d.style.margin="0 auto";Y.appendChild(d);const m=d.getContext("2d"),w=W(c,d);let u={isVisible:!1,position:null,originalCell:null};const K=document.createElement("style");let C=`:root {
`;const q=["#000000","#0000AA","#00AA00","#00AAAA","#AA0000","#AA00AA","#AA5500","#AAAAAA","#555555","#5555FF","#55FF55","#55FFFF","#FF5555","#FF55FF","#FFFF55","#FFFFFF"];q.forEach((i,t)=>{C+=`  --color-${t}: ${i};
`});for(let i=16;i<256;i++){let t=0,e=0,s=0;if(i<232){const o=i-16;t=Math.floor(o/36)*51,e=Math.floor(o%36/6)*51,s=o%6*51}else t=e=s=(i-232)*10+8;C+=`  --color-${i}: #${t.toString(16).padStart(2,"0")}${e.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")};
`}C+="}";K.textContent=C;document.head.appendChild(K);function J(){const i="Event Coordination Demo - Watch events in the log below",t=[7,15,14,13,12,11,10,9];for(let s=0;s<c.getBufferData().width;s++)for(let o=0;o<c.getBufferData().height;o++)if(s===0||s===c.getBufferData().width-1||o===0||o===c.getBufferData().height-1){const r={foreground:t[Math.floor((s+o)%t.length)],background:0,blink:!1};c.writeChar(s,o,"█",r)}i.split("").forEach((s,o)=>{const r={foreground:t[Math.floor(o%t.length)],background:0,blink:!1};c.writeChar(2+o,2,s,r)}),["Event Priority Demo:","- Input events (priority 100)","  • Mouse movement","  • Mouse clicks","  • Keyboard input","","- UI events (priority 50)","  • Show/hide cursor","  • Buffer updates"].forEach((s,o)=>{s.split("").forEach((r,n)=>{const h={foreground:7,background:0,blink:!1};c.writeChar(2+n,5+o,r,h)})})}function Q(i){const t=document.createElement("div");t.className=`event ${i.type.startsWith("INPUT")?"input-event":"ui-event"}`;const e=new Date(i.timestamp).toISOString().split("T")[1].slice(0,-1),s=i.priority.toString().padStart(3,"0");for(t.textContent=`[${e}] (${s}) ${i.type}: ${JSON.stringify(i.data)}`,p.appendChild(t),p.scrollTop=p.scrollHeight;p.children.length>100;)p.removeChild(p.firstChild)}function A(){u.isVisible&&u.position&&u.originalCell&&c.writeChar(u.position.x,u.position.y,u.originalCell.char,{foreground:u.originalCell.fg,background:u.originalCell.bg,blink:!1})}function U(i){const t=["#000000","#0000AA","#00AA00","#00AAAA","#AA0000","#AA00AA","#AA5500","#AAAAAA","#555555","#5555FF","#55FF55","#55FFFF","#FF5555","#FF55FF","#FFFF55","#FFFFFF"];return t[i]||t[7]}function E(i){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function _(i){const t=U(i),e=E(t),s={r:255-e.r,g:255-e.g,b:255-e.b},o=Array(16).fill(0).map((n,h)=>U(h)),r=o.reduce((n,h)=>{const f=E(n),y=E(h),b=Math.abs(f.r-s.r)+Math.abs(f.g-s.g)+Math.abs(f.b-s.b),D=Math.abs(y.r-s.r)+Math.abs(y.g-s.g)+Math.abs(y.b-s.b);return b<D?n:h});return o.indexOf(r)}function Z(i){const e=c.getChar(i.x,i.y)||{char:" ",attributes:{foreground:7,background:0,blink:!1}};u.originalCell={char:e.char||" ",fg:e.attributes.foreground,bg:e.attributes.background};const s=e.char&&e.char.charCodeAt(0)>31?e.char:" ";c.writeChar(i.x,i.y,s,{foreground:_(e.attributes.foreground),background:_(e.attributes.background),blink:!1}),u.position=i,u.isVisible=!0}function tt(i){const{type:t,data:e}=i;switch(t){case g.SHOW_CURSOR:case l.MOUSE_MOVE:case l.MOUSE_DRAG:"position"in e&&e.position&&(A(),Z(e.position));break;case g.HIDE_CURSOR:A(),u.isVisible=!1,u.originalCell=null;break}}function R(){const{width:i,height:t,cells:e}=c.getBufferData(),s=d.width/i,o=d.height/t;m.fillStyle="#000000",m.fillRect(0,0,d.width,d.height);for(let r=0;r<t;r++)for(let n=0;n<i;n++){const h=e[r][n]||{char:" ",attributes:{foreground:7,background:0,blink:!1}},f=getComputedStyle(document.documentElement).getPropertyValue(`--color-${h.attributes.background}`).trim();if(m.fillStyle=f,m.fillRect(n*s,r*o,s,o),h.char&&h.char.charCodeAt(0)>31){const y=getComputedStyle(document.documentElement).getPropertyValue(`--color-${h.attributes.foreground}`).trim();m.fillStyle=y;const b=Math.floor(o*.8);m.font=`bold ${b}px monospace`,m.textAlign="center",m.textBaseline="middle";const D=o*.1;m.fillText(h.char,n*s+s/2,r*o+o/2+D)}}requestAnimationFrame(R)}function B(){const i=w.mouse.getState(),t=w.keyboard.getState();$.textContent=`Mouse: ${i.isVisible?"visible":"hidden"} at ${i.position?`(${i.position.x}, ${i.position.y})`:"N/A"} | Last key: ${t.lastKeyPressed||"None"}`}v(w.mouse);a.subscribe(i=>{Q(i),B()});a.subscribe(tt,{eventTypes:[g.SHOW_CURSOR,g.HIDE_CURSOR,l.MOUSE_MOVE,l.MOUSE_DRAG],minPriority:50});J();R();B();window.addEventListener("unload",()=>{w.cleanup(),a.clear()});
