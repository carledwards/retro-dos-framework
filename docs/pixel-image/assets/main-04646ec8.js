(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();function Ue(t,e){return!(t.x+t.width<=e.x||e.x+e.width<=t.x||t.y+t.height<=e.y||e.y+e.height<=t.y)}function je(t,e){const n=Math.min(t.x,e.x),i=Math.min(t.y,e.y),s=Math.max(t.x+t.width,e.x+e.width),r=Math.max(t.y+t.height,e.y+e.height);return{x:n,y:i,width:s-n,height:r-i}}function $e(t,e){const n=t.y===e.y&&t.height===e.height&&(t.x+t.width===e.x||e.x+e.width===t.x),i=t.x===e.x&&t.width===e.width&&(t.y+t.height===e.y||e.y+e.height===t.y);return n||i}class P{constructor(e=80,n=25){this.width=e,this.height=n,this.buffer=Array(n).fill(null).map(()=>Array(e).fill(null)),this.cursor={x:0,y:0,visible:!0,blinking:!0},this.dirtyRegions=[],this.batchRegions=[],this.batchMode=!1}writeChar(e,n,i,s){if(e<0||e>=this.width||n<0||n>=this.height)return;const r={char:i[0],attributes:s};this.buffer[n][e]=r,this.markDirty(e,n,1,1)}getChar(e,n){return e<0||e>=this.width||n<0||n>=this.height?null:this.buffer[n][e]}resize(e,n){const i=Array(n).fill(null).map(()=>Array(e).fill(null));for(let s=0;s<Math.min(n,this.height);s++)for(let r=0;r<Math.min(e,this.width);r++)i[s][r]=this.buffer[s][r];this.width=e,this.height=n,this.buffer=i,this.markDirty(0,0,e,n),this.cursor.x=Math.min(this.cursor.x,e-1),this.cursor.y=Math.min(this.cursor.y,n-1)}clear(){for(let e=0;e<this.height;e++)for(let n=0;n<this.width;n++)this.buffer[e][n]!==null&&this.markDirty(n,e,1,1);this.buffer=Array(this.height).fill(null).map(()=>Array(this.width).fill(null))}setCursorPosition(e,n){e<0||e>=this.width||n<0||n>=this.height||(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.markDirty(e,n,1,1),this.cursor.x=e,this.cursor.y=n)}getCursorPosition(){return{x:this.cursor.x,y:this.cursor.y}}setCursorVisible(e){this.cursor.visible!==e&&(this.cursor.visible=e,this.markDirty(this.cursor.x,this.cursor.y,1,1))}setCursorBlinking(e){this.cursor.blinking!==e&&(this.cursor.blinking=e,this.markDirty(this.cursor.x,this.cursor.y,1,1))}beginBatch(){this.batchMode=!0,this.batchRegions=[]}endBatch(){this.batchMode=!1,this.batchRegions.length>0&&(this.optimizeAndAddRegions(this.batchRegions),this.batchRegions=[])}flush(){const e=[...this.dirtyRegions];return this.dirtyRegions=[],e}getBufferData(){if(this.cursor.visible&&this.cursor.blinking){const e=performance.now();(!this.cursor.lastBlinkTime||Math.floor(this.cursor.lastBlinkTime/500)!==Math.floor(e/500))&&(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.cursor.lastBlinkTime=e)}return{width:this.width,height:this.height,cells:this.buffer,cursor:{...this.cursor}}}getDirtyRegions(){const e=[...this.dirtyRegions];return this.dirtyRegions=[],e}markDirty(e,n,i,s){const r={x:e,y:n,width:i,height:s};this.batchMode?this.batchRegions.push(r):this.optimizeAndAddRegions([r])}optimizeAndAddRegions(e){let n=[...this.dirtyRegions,...e],i=[],s;do{for(s=!1;n.length>0;){const r=n.pop();let u=!1;for(let h=0;h<i.length;h++)if(Ue(r,i[h])||$e(r,i[h])){i[h]=je(r,i[h]),u=!0,s=!0;break}u||i.push(r)}s&&(n=i,i=[])}while(s);this.dirtyRegions=i}}function Ve(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function X(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Be={exports:{}};(function(t,e){(function(n){t.exports=n()})(function(){return function n(i,s,r){function u(g,a){if(!s[g]){if(!i[g]){var l=typeof X=="function"&&X;if(!a&&l)return l(g,!0);if(h)return h(g,!0);var c=new Error("Cannot find module '"+g+"'");throw c.code="MODULE_NOT_FOUND",c}var p=s[g]={exports:{}};i[g][0].call(p.exports,function(v){var y=i[g][1][v];return u(y||v)},p,p.exports,n,i,s,r)}return s[g].exports}for(var h=typeof X=="function"&&X,m=0;m<r.length;m++)u(r[m]);return u}({1:[function(n,i,s){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}i.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(a){if(!h(a)||a<0||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},r.prototype.emit=function(a){var l,c,p,v,y,o;if(this._events||(this._events={}),a==="error"&&(!this._events.error||m(this._events.error)&&!this._events.error.length)){if(l=arguments[1],l instanceof Error)throw l;var f=new Error('Uncaught, unspecified "error" event. ('+l+")");throw f.context=l,f}if(c=this._events[a],g(c))return!1;if(u(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:v=Array.prototype.slice.call(arguments,1),c.apply(this,v)}else if(m(c))for(v=Array.prototype.slice.call(arguments,1),o=c.slice(),p=o.length,y=0;y<p;y++)o[y].apply(this,v);return!0},r.prototype.addListener=function(a,l){var c;if(!u(l))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,u(l.listener)?l.listener:l),this._events[a]?m(this._events[a])?this._events[a].push(l):this._events[a]=[this._events[a],l]:this._events[a]=l,m(this._events[a])&&!this._events[a].warned&&(g(this._maxListeners)?c=r.defaultMaxListeners:c=this._maxListeners,c&&c>0&&this._events[a].length>c&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),typeof console.trace=="function"&&console.trace())),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(a,l){if(!u(l))throw TypeError("listener must be a function");var c=!1;function p(){this.removeListener(a,p),c||(c=!0,l.apply(this,arguments))}return p.listener=l,this.on(a,p),this},r.prototype.removeListener=function(a,l){var c,p,v,y;if(!u(l))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],v=c.length,p=-1,c===l||u(c.listener)&&c.listener===l)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,l);else if(m(c)){for(y=v;y-- >0;)if(c[y]===l||c[y].listener&&c[y].listener===l){p=y;break}if(p<0)return this;c.length===1?(c.length=0,delete this._events[a]):c.splice(p,1),this._events.removeListener&&this.emit("removeListener",a,l)}return this},r.prototype.removeAllListeners=function(a){var l,c;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[a]&&delete this._events[a],this;if(arguments.length===0){for(l in this._events)l!=="removeListener"&&this.removeAllListeners(l);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],u(c))this.removeListener(a,c);else if(c)for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},r.prototype.listeners=function(a){var l;return!this._events||!this._events[a]?l=[]:u(this._events[a])?l=[this._events[a]]:l=this._events[a].slice(),l},r.prototype.listenerCount=function(a){if(this._events){var l=this._events[a];if(u(l))return 1;if(l)return l.length}return 0},r.listenerCount=function(a,l){return a.listenerCount(l)};function u(a){return typeof a=="function"}function h(a){return typeof a=="number"}function m(a){return typeof a=="object"&&a!==null}function g(a){return a===void 0}},{}],2:[function(n,i,s){var r,u,h,m,g;g=navigator.userAgent.toLowerCase(),m=navigator.platform.toLowerCase(),r=g.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],h=r[1]==="ie"&&document.documentMode,u={name:r[1]==="version"?r[3]:r[1],version:h||parseFloat(r[1]==="opera"&&r[4]?r[4]:r[2]),platform:{name:g.match(/ip(?:ad|od|hone)/)?"ios":(g.match(/(?:webos|android)/)||m.match(/mac|win|linux/)||["other"])[0]}},u[u.name]=!0,u[u.name+parseInt(u.version,10)]=!0,u.platform[u.platform.name]=!0,i.exports=u},{}],3:[function(n,i,s){var r,u,h,m=function(c,p){for(var v in p)g.call(p,v)&&(c[v]=p[v]);function y(){this.constructor=c}return y.prototype=p.prototype,c.prototype=new y,c.__super__=p.prototype,c},g={}.hasOwnProperty,a=[].indexOf||function(c){for(var p=0,v=this.length;p<v;p++)if(p in this&&this[p]===c)return p;return-1},l=[].slice;r=n("events").EventEmitter,h=n("./browser.coffee"),u=function(c){var p,v;m(y,c),p={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},v={delay:500,copy:!1};function y(o){var f,d,w;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(o);for(d in p)w=p[d],(f=this.options)[d]==null&&(f[d]=w)}return y.prototype.setOption=function(o,f){if(this.options[o]=f,this._canvas!=null&&(o==="width"||o==="height"))return this._canvas[o]=f},y.prototype.setOptions=function(o){var f,d,w;d=[];for(f in o)g.call(o,f)&&(w=o[f],d.push(this.setOption(f,w)));return d},y.prototype.addFrame=function(o,f){var d,w;f==null&&(f={}),d={},d.transparent=this.options.transparent;for(w in v)d[w]=f[w]||v[w];if(this.options.width==null&&this.setOption("width",o.width),this.options.height==null&&this.setOption("height",o.height),typeof ImageData<"u"&&ImageData!==null&&o instanceof ImageData)d.data=o.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&o instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&o instanceof WebGLRenderingContext)f.copy?d.data=this.getContextData(o):d.context=o;else if(o.childNodes!=null)f.copy?d.data=this.getImageData(o):d.image=o;else throw new Error("Invalid image");return this.frames.push(d)},y.prototype.render=function(){var o,f,d;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=(function(){var w,E,b;for(b=[],w=0,E=this.frames.length;0<=E?w<E:w>E;0<=E?++w:--w)b.push(null);return b}).call(this),f=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(o=0,d=f;0<=d?o<d:o>d;0<=d?++o:--o)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},y.prototype.abort=function(){for(var o;o=this.activeWorkers.shift(),o!=null;)this.log("killing active worker"),o.terminate();return this.running=!1,this.emit("abort")},y.prototype.spawnWorkers=function(){var o,f,d;return o=Math.min(this.options.workers,this.frames.length),(function(){d=[];for(var w=f=this.freeWorkers.length;f<=o?w<o:w>o;f<=o?w++:w--)d.push(w);return d}).apply(this).forEach(function(w){return function(E){var b;return w.log("spawning worker "+E),b=new Worker(w.options.workerScript),b.onmessage=function(L){return w.activeWorkers.splice(w.activeWorkers.indexOf(b),1),w.freeWorkers.push(b),w.frameFinished(L.data)},w.freeWorkers.push(b)}}(this)),o},y.prototype.frameFinished=function(o){var f,d;if(this.log("frame "+o.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[o.index]=o,this.options.globalPalette===!0&&(this.options.globalPalette=o.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(f=1,d=this.freeWorkers.length;1<=d?f<d:f>d;1<=d?++f:--f)this.renderNextFrame();return a.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},y.prototype.finishRendering=function(){var o,f,d,w,E,b,L,F,$,V,Y,T,xe,ue,he,fe;for(F=0,ue=this.imageParts,E=0,$=ue.length;E<$;E++)f=ue[E],F+=(f.data.length-1)*f.pageSize+f.cursor;for(F+=f.pageSize-f.cursor,this.log("rendering finished - filesize "+Math.round(F/1e3)+"kb"),o=new Uint8Array(F),T=0,he=this.imageParts,b=0,V=he.length;b<V;b++)for(f=he[b],fe=f.data,d=L=0,Y=fe.length;L<Y;d=++L)xe=fe[d],o.set(xe,T),d===f.data.length-1?T+=f.cursor:T+=f.pageSize;return w=new Blob([o],{type:"image/gif"}),this.emit("finished",w,o)},y.prototype.renderNextFrame=function(){var o,f,d;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return o=this.frames[this.nextFrame++],d=this.freeWorkers.shift(),f=this.getTask(o),this.log("starting frame "+(f.index+1)+" of "+this.frames.length),this.activeWorkers.push(d),d.postMessage(f)},y.prototype.getContextData=function(o){return o.getImageData(0,0,this.options.width,this.options.height).data},y.prototype.getImageData=function(o){var f;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),f=this._canvas.getContext("2d"),f.setFill=this.options.background,f.fillRect(0,0,this.options.width,this.options.height),f.drawImage(o,0,0),this.getContextData(f)},y.prototype.getTask=function(o){var f,d;if(f=this.frames.indexOf(o),d={index:f,last:f===this.frames.length-1,delay:o.delay,transparent:o.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:h.name==="chrome"},o.data!=null)d.data=o.data;else if(o.context!=null)d.data=this.getContextData(o.context);else if(o.image!=null)d.data=this.getImageData(o.image);else throw new Error("Invalid frame");return d},y.prototype.log=function(){var o;if(o=1<=arguments.length?l.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,o)},y}(r),i.exports=u},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(Be);var Ye=Be.exports;const Xe=Ve(Ye),Ke=document.getElementById("imageInput"),M=document.getElementById("gifStartSize"),S=document.getElementById("gifEndSize"),oe=document.getElementById("gifFrameCount"),G=document.getElementById("gifAnimationType"),Q=document.getElementById("gifDelay"),ae=document.getElementById("gifLoopPause"),ge=document.getElementById("gifTimingCurve"),le=document.getElementById("gifColorPalette"),ce=document.getElementById("gifColorMode"),Je=document.getElementById("gifPreview"),Qe=document.querySelector(".gif-preview"),Ze=Qe.querySelector(".save-gif"),He=document.getElementById("saveFormat");let A=[],O=null;const I=document.getElementById("fullImage"),Z=document.getElementById("screenFull"),H=document.getElementById("screen256"),ee=document.getElementById("screen16"),te=document.getElementById("screenFullBW"),ne=document.getElementById("screen256BW"),re=document.getElementById("screen16BW"),et=I.getContext("2d",{willReadFrequently:!0});Z.getContext("2d",{willReadFrequently:!0});H.getContext("2d",{willReadFrequently:!0});ee.getContext("2d",{willReadFrequently:!0});te.getContext("2d",{willReadFrequently:!0});ne.getContext("2d",{willReadFrequently:!0});re.getContext("2d",{willReadFrequently:!0});var Ee,Ce,ke,Re,Le,Fe;const k=[{canvas:Z,buffer:null,overlay:(Ee=Z.parentElement)==null?void 0:Ee.querySelector(".rendering-overlay")},{canvas:H,buffer:null,overlay:(Ce=H.parentElement)==null?void 0:Ce.querySelector(".rendering-overlay")},{canvas:ee,buffer:null,overlay:(ke=ee.parentElement)==null?void 0:ke.querySelector(".rendering-overlay")},{canvas:te,buffer:null,overlay:(Re=te.parentElement)==null?void 0:Re.querySelector(".rendering-overlay")},{canvas:ne,buffer:null,overlay:(Le=ne.parentElement)==null?void 0:Le.querySelector(".rendering-overlay")},{canvas:re,buffer:null,overlay:(Fe=re.parentElement)==null?void 0:Fe.querySelector(".rendering-overlay")}],ie=document.getElementById("gridSize");let x=parseInt(ie.value),q=null,R=document.querySelector(".selection-box"),U=!1,j=!1,C=null,Me=0,De=0,_=0,W=0,N=0,B=null,D=!1,J=!1;const se=[[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]];function tt(){const t=[];for(let e=0;e<32;e++){const n=Math.round(e*255/31);for(let i=0;i<64;i++){const s=Math.round(i*255/63);for(let r=0;r<32;r++){const u=Math.round(r*255/31);t.push([n,s,u])}}}return t}function nt(){const t=[];for(let e=0;e<6;e++)for(let n=0;n<6;n++)for(let i=0;i<6;i++)t.push([Math.round(e*51),Math.round(n*51),Math.round(i*51)]);for(let e=0;e<40;e++){const n=Math.round(e*255/39);t.push([n,n,n])}return t}const me=tt(),pe=nt();function rt(){switch(le.value){case"16bit":return me;case"256":return pe;case"16":return se;default:return se}}function it(t,e,n){return Math.round(.299*t+.587*e+.114*n)}function Pe(t,e,n,i,s=!1){if(s&&(t=e=n=it(t,e,n)),i.length===65536){const h=Math.round(t*31/255),m=Math.round(e*63/255),g=Math.round(n*31/255);return h<<11|m<<5|g}let r=1/0,u=0;for(let h=0;h<i.length;h++){const[m,g,a]=i[h],l=Math.sqrt(Math.pow(t-m,2)+Math.pow(e-g,2)+Math.pow(n-a,2));l<r&&(r=l,u=h)}return u}function qe(t,e,n){const i=ge.value,s=e/n;switch(i){case"linear":return t*(2-s);case"curved":return t*(1+(1-s)*(1-s));default:return t}}function ve(t,e,n){return Math.round(t+(e-t)*n)}function Te(t){const e=I.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}function st(t,e,n){const i=I.width,s=I.height,r=I.getBoundingClientRect().width/i;return t=Math.max(0,Math.min(t,i*r-n)),e=Math.max(0,Math.min(e,s*r-n)),{left:t,top:e}}function de(t,e,n){const{left:i,top:s}=st(t,e,n);R.style.left=`${i}px`,R.style.top=`${s}px`,R.style.width=`${n}px`,R.style.height=`${n}px`}function ot(){if(!q)return;const t=I.getBoundingClientRect(),e=Math.min(t.width,t.height),n=(t.width-e)/2,i=(t.height-e)/2;de(n,i,e)}function at(t){t.classList.add("active")}function be(t){t.classList.remove("active")}async function lt(t,e,n,i,s,r){return new Promise((u,h)=>{at(r);let m=0;const g=8;function a(){if(D){be(r),h(new Error("Processing cancelled"));return}const l=Math.min(m+g,x);for(;m<l;m++)for(let c=0;c<x;c++){const p=(m*x+c)*4,v=t.data[p],y=t.data[p+1],o=t.data[p+2],f=Pe(v,y,o,i,s);e.writeChar(c,m," ",{foreground:0,background:f})}m<x?requestAnimationFrame(a):(D||ye(e,n,i),be(r),u())}a()})}function ye(t,e,n,i){const{cells:s}=t.getBufferData(),r=i||x;e.fillStyle="#000",e.fillRect(0,0,e.canvas.width,e.canvas.height);for(let u=0;u<r;u++)if(s[u])for(let h=0;h<r;h++){const m=s[u][h];if(m&&m.attributes&&typeof m.attributes.background=="number"){const g=n[m.attributes.background];g&&(e.fillStyle=`rgb(${g[0]}, ${g[1]}, ${g[2]})`,e.fillRect(h,u,1,1))}}}async function ct(){if(!q)return;const t=I.getBoundingClientRect(),e=I.width/t.width,n=R.getBoundingClientRect(),i={left:(n.left-t.left)*e,top:(n.top-t.top)*e,width:n.width*e,height:n.height*e},s=document.createElement("canvas");s.width=x,s.height=x;const r=s.getContext("2d",{willReadFrequently:!0});r.drawImage(I,i.left,i.top,i.width,i.height,0,0,x,x);const u=r.getImageData(0,0,x,x);for(let h=0;h<k.length&&!D;h++){const m=k[h];if(m.buffer){const g=h%3===0?me:h%3===1?pe:se,a=h>=3;try{await lt(u,m.buffer,m.canvas.getContext("2d"),g,a,m.overlay),h<k.length-1&&!D&&await new Promise(l=>setTimeout(l,100))}catch(l){if(l.message==="Processing cancelled")break;throw l}}}}function ut(){le.value="256",ce.value="bw",ge.value="curved",M.value="4",S.value="128",oe.value="20",G.value="loop",ae.value="2000"}async function Ae(){const t=parseInt(M.value),e=parseInt(S.value),n=parseInt(oe.value),i=parseInt(Q.value),s=G.value;A=await Ne(t,e,n),ft(A,i,s)}function ht(t){q=t;const e=t.width/t.height;I.width=800,I.height=Math.round(800/e),et.drawImage(t,0,0,I.width,I.height),ot(),we(),ut(),setTimeout(Ae,1500)}function ze(t){const e=new Image,n=new FileReader;n.onload=i=>{var s;(s=i.target)!=null&&s.result&&(e.src=i.target.result,e.onload=()=>ht(e))},n.readAsDataURL(t)}function we(){B!==null&&(window.clearTimeout(B),B=null),D=!0,B=window.setTimeout(async()=>{if(!J){D=!1,J=!0;try{await ct()}catch(t){t.message!=="Processing cancelled"&&console.error("Processing error:",t)}finally{J=!1,B=null}}},1e3)}function Oe(){[Z,H,ee,te,ne,re].forEach(t=>{t.width=x,t.height=x}),k[0].buffer=new P(x,x),k[1].buffer=new P(x,x),k[2].buffer=new P(x,x),k[3].buffer=new P(x,x),k[4].buffer=new P(x,x),k[5].buffer=new P(x,x),k.forEach(t=>{t.buffer&&(t.buffer.clear(),t.buffer.setCursorVisible(!1))})}function We(){k.forEach((t,e)=>{if(t.buffer){const n=e%3===0?me:e%3===1?pe:se;ye(t.buffer,t.canvas.getContext("2d"),n)}})}async function Ne(t,e,n){const i=rt(),s=ce.value==="bw",r=[],u=document.createElement("canvas");u.width=256,u.height=256;const h=u.getContext("2d",{willReadFrequently:!0});h.imageSmoothingEnabled=!1;const m=I.getBoundingClientRect(),g=I.width/m.width,a=R.getBoundingClientRect(),l={left:(a.left-m.left)*g,top:(a.top-m.top)*g,width:a.width*g,height:a.height*g};for(let c=0;c<n;c++){const p=c/(n-1),v=ve(t,e,p),y=document.createElement("canvas");y.width=v,y.height=v;const o=y.getContext("2d",{willReadFrequently:!0});o.drawImage(I,l.left,l.top,l.width,l.height,0,0,v,v);const f=new P(v,v),d=o.getImageData(0,0,v,v);for(let b=0;b<v;b++)for(let L=0;L<v;L++){const F=(b*v+L)*4,$=d.data[F],V=d.data[F+1],Y=d.data[F+2],T=Pe($,V,Y,i,s);f.writeChar(L,b," ",{foreground:0,background:T})}const w=document.createElement("canvas");w.width=v,w.height=v;const E=w.getContext("2d",{willReadFrequently:!0});ye(f,E,i,v),h.clearRect(0,0,256,256),h.drawImage(w,0,0,256,256),r.push(h.getImageData(0,0,256,256))}return r}function ft(t,e,n){const i=Je.getContext("2d",{willReadFrequently:!0});let s=!0,r=0,u=0;const h=parseInt(ae.value);O!==null&&window.clearInterval(O),O=window.setInterval(()=>{if(u>0){u--;return}i.putImageData(t[r],0,0);const m=ve(parseInt(M.value),parseInt(S.value),r/(t.length-1)),g=qe(e,m,parseInt(S.value));n==="once"?(r=(r+1)%t.length,r===0&&(window.clearInterval(O),O=null)):n==="loop"?(r=(r+1)%t.length,r===0&&h>0&&(u=Math.floor(h/g))):n==="bounce"&&(s?(r++,r>=t.length-1&&(s=!1,h>0&&(u=Math.floor(h/g)))):(r--,r<=0&&(s=!0,h>0&&(u=Math.floor(h/g)))))},e)}function Ie(t,e,n,i){const s=new Xe({workers:2,quality:10,width:256,height:256,workerScript:"gif.worker.js",repeat:n==="once"?1:0}),r=document.createElement("canvas");r.width=256,r.height=256;const u=r.getContext("2d",{willReadFrequently:!0}),h=parseInt(ae.value),m=parseInt(M.value),g=parseInt(S.value),a=(l,c)=>{u.putImageData(l,0,0);const p=ve(m,g,c),v=qe(e,p,g);s.addFrame(r,{delay:v,copy:!0})};if(n==="bounce"){t.forEach((l,c)=>{a(l,c/(t.length-1))}),h>0&&(u.putImageData(t[t.length-1],0,0),s.addFrame(r,{delay:h,copy:!0}));for(let l=t.length-2;l>0;l--)a(t[l],l/(t.length-1));h>0&&(u.putImageData(t[0],0,0),s.addFrame(r,{delay:h,copy:!0}))}else t.forEach((l,c)=>{a(l,c/(t.length-1)),h>0&&c===t.length-1&&(u.putImageData(l,0,0),s.addFrame(r,{delay:h,copy:!0}))});s.on("finished",l=>{const c=URL.createObjectURL(l),p=document.createElement("a");p.download=`${i}.gif`,p.href=c,p.click(),URL.revokeObjectURL(c)}),s.render()}Ke.addEventListener("change",t=>{const e=t.target.files;e&&e[0]&&ze(e[0])});const K=new URLSearchParams(window.location.search).get("debug")==="true";document.addEventListener("paste",t=>{var n;const e=(n=t.clipboardData)==null?void 0:n.items;if(!e){K&&console.log("No clipboard data items found");return}K&&(console.log("Clipboard items:",Array.from(e).map(i=>({kind:i.kind,type:i.type}))),console.log("Raw clipboard data:",t.clipboardData));for(const i of e)if(K&&console.log("Processing item:",{kind:i.kind,type:i.type}),i.type.indexOf("image")!==-1){const s=i.getAsFile();if(s){K&&console.log("Found image file:",{name:s.name,type:s.type,size:s.size}),ze(s);break}}});function Ge(t){if(isNaN(t)||t<=0)return;const e=x;ie.value=t.toString(),parseInt(M.value)===e&&(M.value=t.toString(),z()),parseInt(S.value)===e&&(S.value=t.toString(),z()),D=!0,B!==null&&(window.clearTimeout(B),B=null);const n=async()=>{J&&(await new Promise(i=>setTimeout(i,50)),await n())};n().then(()=>{if(x=t,Oe(),!k.every(s=>s.buffer&&s.buffer.getBufferData().cells.length===x)){console.error("Buffer initialization failed");return}D=!1,q?we():requestAnimationFrame(()=>We())})}ie.addEventListener("change",()=>{Ge(parseInt(ie.value))});document.querySelectorAll(".grid-size-btn").forEach(t=>{t.addEventListener("click",()=>{const e=parseInt(t.dataset.size||"0");Ge(e)})});R.addEventListener("mousedown",t=>{if(!q)return;const e=t.target;e.classList.contains("selection-handle")?(j=!0,C=e):U=!0;const n=Te(t);Me=n.x,De=n.y,W=parseFloat(R.style.left)||0,N=parseFloat(R.style.top)||0,_=parseFloat(R.style.width)||0,parseFloat(R.style.height),t.preventDefault()});document.addEventListener("mousemove",t=>{if(!q||!U&&!j)return;const e=Te(t),n=e.x-Me,i=e.y-De;if(U)de(W+n,N+i,_);else if(j){let s=_,r=W,u=N;if(C!=null&&C.classList.contains("se"))s=Math.max(_+n,_+i);else if(C!=null&&C.classList.contains("sw")){const h=Math.max(-n,i);s=_+h,r=W-h}else if(C!=null&&C.classList.contains("ne")){const h=Math.max(n,-i);s=_+h,u=N-h}else if(C!=null&&C.classList.contains("nw")){const h=Math.max(-n,-i);s=_+h,r=W-h,u=N-h}de(r,u,s)}});document.addEventListener("mouseup",()=>{(U||j)&&(U=!1,j=!1,C=null,we(),setTimeout(z,250))});Ze.addEventListener("click",()=>{const t=document.querySelector(".save-dialog"),e=document.getElementById("saveFormat"),n=document.getElementById("saveFilename");e.value="gif",e.disabled=!0,n.value="pixel-animation",t.style.display="flex"});var Se;(Se=document.querySelector(".save-ok"))==null||Se.addEventListener("click",async()=>{const t=document.querySelector(".save-dialog"),e=document.getElementById("saveFilename").value;if(A.length===0){const n=parseInt(M.value),i=parseInt(S.value),s=parseInt(oe.value),r=parseInt(Q.value),u=G.value;A=await Ne(n,i,s),Ie(A,r,u,e)}else{const n=parseInt(Q.value),i=G.value;Ie(A,n,i,e)}t.style.display="none",He.disabled=!1});var _e;(_e=document.querySelector(".save-cancel"))==null||_e.addEventListener("click",()=>{const t=document.querySelector(".save-dialog"),e=document.getElementById("saveFormat");t.style.display="none",e.disabled=!1});const z=()=>{q&&Ae()};[M,S,oe].forEach(t=>{t.addEventListener("input",z)});[G,Q,ae,ge,le,ce].forEach(t=>{t.addEventListener("change",z)});document.querySelectorAll(".action-overlay").forEach(t=>{const e=t.querySelector(".set-gif");e&&e.addEventListener("click",()=>{const n=t.dataset.palette,i=t.dataset.mode;n&&i&&(le.value=n,ce.value=i,z())})});Oe();We();
