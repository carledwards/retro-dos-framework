(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();function Ue(t,e){return!(t.x+t.width<=e.x||e.x+e.width<=t.x||t.y+t.height<=e.y||e.y+e.height<=t.y)}function $e(t,e){const n=Math.min(t.x,e.x),i=Math.min(t.y,e.y),s=Math.max(t.x+t.width,e.x+e.width),r=Math.max(t.y+t.height,e.y+e.height);return{x:n,y:i,width:s-n,height:r-i}}function Ve(t,e){const n=t.y===e.y&&t.height===e.height&&(t.x+t.width===e.x||e.x+e.width===t.x),i=t.x===e.x&&t.width===e.width&&(t.y+t.height===e.y||e.y+e.height===t.y);return n||i}class P{constructor(e=80,n=25){this.width=e,this.height=n,this.buffer=Array(n).fill(null).map(()=>Array(e).fill(null)),this.cursor={x:0,y:0,visible:!0,blinking:!0},this.dirtyRegions=[],this.batchRegions=[],this.batchMode=!1}writeChar(e,n,i,s){if(e<0||e>=this.width||n<0||n>=this.height)return;const r={char:i[0],attributes:s};this.buffer[n][e]=r,this.markDirty(e,n,1,1)}getChar(e,n){return e<0||e>=this.width||n<0||n>=this.height?null:this.buffer[n][e]}resize(e,n){const i=Array(n).fill(null).map(()=>Array(e).fill(null));for(let s=0;s<Math.min(n,this.height);s++)for(let r=0;r<Math.min(e,this.width);r++)i[s][r]=this.buffer[s][r];this.width=e,this.height=n,this.buffer=i,this.markDirty(0,0,e,n),this.cursor.x=Math.min(this.cursor.x,e-1),this.cursor.y=Math.min(this.cursor.y,n-1)}clear(){for(let e=0;e<this.height;e++)for(let n=0;n<this.width;n++)this.buffer[e][n]!==null&&this.markDirty(n,e,1,1);this.buffer=Array(this.height).fill(null).map(()=>Array(this.width).fill(null))}setCursorPosition(e,n){e<0||e>=this.width||n<0||n>=this.height||(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.markDirty(e,n,1,1),this.cursor.x=e,this.cursor.y=n)}getCursorPosition(){return{x:this.cursor.x,y:this.cursor.y}}setCursorVisible(e){this.cursor.visible!==e&&(this.cursor.visible=e,this.markDirty(this.cursor.x,this.cursor.y,1,1))}setCursorBlinking(e){this.cursor.blinking!==e&&(this.cursor.blinking=e,this.markDirty(this.cursor.x,this.cursor.y,1,1))}beginBatch(){this.batchMode=!0,this.batchRegions=[]}endBatch(){this.batchMode=!1,this.batchRegions.length>0&&(this.optimizeAndAddRegions(this.batchRegions),this.batchRegions=[])}flush(){const e=[...this.dirtyRegions];return this.dirtyRegions=[],e}getBufferData(){if(this.cursor.visible&&this.cursor.blinking){const e=performance.now();(!this.cursor.lastBlinkTime||Math.floor(this.cursor.lastBlinkTime/500)!==Math.floor(e/500))&&(this.markDirty(this.cursor.x,this.cursor.y,1,1),this.cursor.lastBlinkTime=e)}return{width:this.width,height:this.height,cells:this.buffer,cursor:{...this.cursor}}}getDirtyRegions(){const e=[...this.dirtyRegions];return this.dirtyRegions=[],e}markDirty(e,n,i,s){const r={x:e,y:n,width:i,height:s};this.batchMode?this.batchRegions.push(r):this.optimizeAndAddRegions([r])}optimizeAndAddRegions(e){let n=[...this.dirtyRegions,...e],i=[],s;do{for(s=!1;n.length>0;){const r=n.pop();let l=!1;for(let u=0;u<i.length;u++)if(Ue(r,i[u])||Ve(r,i[u])){i[u]=$e(r,i[u]),l=!0,s=!0;break}l||i.push(r)}s&&(n=i,i=[])}while(s);this.dirtyRegions=i}}function Je(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Y(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var De={exports:{}};(function(t,e){(function(n){t.exports=n()})(function(){return function n(i,s,r){function l(m,a){if(!s[m]){if(!i[m]){var c=typeof Y=="function"&&Y;if(!a&&c)return c(m,!0);if(u)return u(m,!0);var h=new Error("Cannot find module '"+m+"'");throw h.code="MODULE_NOT_FOUND",h}var p=s[m]={exports:{}};i[m][0].call(p.exports,function(v){var y=i[m][1][v];return l(y||v)},p,p.exports,n,i,s,r)}return s[m].exports}for(var u=typeof Y=="function"&&Y,g=0;g<r.length;g++)l(r[g]);return l}({1:[function(n,i,s){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}i.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(a){if(!u(a)||a<0||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},r.prototype.emit=function(a){var c,h,p,v,y,o;if(this._events||(this._events={}),a==="error"&&(!this._events.error||g(this._events.error)&&!this._events.error.length)){if(c=arguments[1],c instanceof Error)throw c;var f=new Error('Uncaught, unspecified "error" event. ('+c+")");throw f.context=c,f}if(h=this._events[a],m(h))return!1;if(l(h))switch(arguments.length){case 1:h.call(this);break;case 2:h.call(this,arguments[1]);break;case 3:h.call(this,arguments[1],arguments[2]);break;default:v=Array.prototype.slice.call(arguments,1),h.apply(this,v)}else if(g(h))for(v=Array.prototype.slice.call(arguments,1),o=h.slice(),p=o.length,y=0;y<p;y++)o[y].apply(this,v);return!0},r.prototype.addListener=function(a,c){var h;if(!l(c))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,l(c.listener)?c.listener:c),this._events[a]?g(this._events[a])?this._events[a].push(c):this._events[a]=[this._events[a],c]:this._events[a]=c,g(this._events[a])&&!this._events[a].warned&&(m(this._maxListeners)?h=r.defaultMaxListeners:h=this._maxListeners,h&&h>0&&this._events[a].length>h&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),typeof console.trace=="function"&&console.trace())),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(a,c){if(!l(c))throw TypeError("listener must be a function");var h=!1;function p(){this.removeListener(a,p),h||(h=!0,c.apply(this,arguments))}return p.listener=c,this.on(a,p),this},r.prototype.removeListener=function(a,c){var h,p,v,y;if(!l(c))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(h=this._events[a],v=h.length,p=-1,h===c||l(h.listener)&&h.listener===c)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,c);else if(g(h)){for(y=v;y-- >0;)if(h[y]===c||h[y].listener&&h[y].listener===c){p=y;break}if(p<0)return this;h.length===1?(h.length=0,delete this._events[a]):h.splice(p,1),this._events.removeListener&&this.emit("removeListener",a,c)}return this},r.prototype.removeAllListeners=function(a){var c,h;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[a]&&delete this._events[a],this;if(arguments.length===0){for(c in this._events)c!=="removeListener"&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events={},this}if(h=this._events[a],l(h))this.removeListener(a,h);else if(h)for(;h.length;)this.removeListener(a,h[h.length-1]);return delete this._events[a],this},r.prototype.listeners=function(a){var c;return!this._events||!this._events[a]?c=[]:l(this._events[a])?c=[this._events[a]]:c=this._events[a].slice(),c},r.prototype.listenerCount=function(a){if(this._events){var c=this._events[a];if(l(c))return 1;if(c)return c.length}return 0},r.listenerCount=function(a,c){return a.listenerCount(c)};function l(a){return typeof a=="function"}function u(a){return typeof a=="number"}function g(a){return typeof a=="object"&&a!==null}function m(a){return a===void 0}},{}],2:[function(n,i,s){var r,l,u,g,m;m=navigator.userAgent.toLowerCase(),g=navigator.platform.toLowerCase(),r=m.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],u=r[1]==="ie"&&document.documentMode,l={name:r[1]==="version"?r[3]:r[1],version:u||parseFloat(r[1]==="opera"&&r[4]?r[4]:r[2]),platform:{name:m.match(/ip(?:ad|od|hone)/)?"ios":(m.match(/(?:webos|android)/)||g.match(/mac|win|linux/)||["other"])[0]}},l[l.name]=!0,l[l.name+parseInt(l.version,10)]=!0,l.platform[l.platform.name]=!0,i.exports=l},{}],3:[function(n,i,s){var r,l,u,g=function(h,p){for(var v in p)m.call(p,v)&&(h[v]=p[v]);function y(){this.constructor=h}return y.prototype=p.prototype,h.prototype=new y,h.__super__=p.prototype,h},m={}.hasOwnProperty,a=[].indexOf||function(h){for(var p=0,v=this.length;p<v;p++)if(p in this&&this[p]===h)return p;return-1},c=[].slice;r=n("events").EventEmitter,u=n("./browser.coffee"),l=function(h){var p,v;g(y,h),p={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},v={delay:500,copy:!1};function y(o){var f,d,w;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(o);for(d in p)w=p[d],(f=this.options)[d]==null&&(f[d]=w)}return y.prototype.setOption=function(o,f){if(this.options[o]=f,this._canvas!=null&&(o==="width"||o==="height"))return this._canvas[o]=f},y.prototype.setOptions=function(o){var f,d,w;d=[];for(f in o)m.call(o,f)&&(w=o[f],d.push(this.setOption(f,w)));return d},y.prototype.addFrame=function(o,f){var d,w;f==null&&(f={}),d={},d.transparent=this.options.transparent;for(w in v)d[w]=f[w]||v[w];if(this.options.width==null&&this.setOption("width",o.width),this.options.height==null&&this.setOption("height",o.height),typeof ImageData<"u"&&ImageData!==null&&o instanceof ImageData)d.data=o.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&o instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&o instanceof WebGLRenderingContext)f.copy?d.data=this.getContextData(o):d.context=o;else if(o.childNodes!=null)f.copy?d.data=this.getImageData(o):d.image=o;else throw new Error("Invalid image");return this.frames.push(d)},y.prototype.render=function(){var o,f,d;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=(function(){var w,I,b;for(b=[],w=0,I=this.frames.length;0<=I?w<I:w>I;0<=I?++w:--w)b.push(null);return b}).call(this),f=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(o=0,d=f;0<=d?o<d:o>d;0<=d?++o:--o)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},y.prototype.abort=function(){for(var o;o=this.activeWorkers.shift(),o!=null;)this.log("killing active worker"),o.terminate();return this.running=!1,this.emit("abort")},y.prototype.spawnWorkers=function(){var o,f,d;return o=Math.min(this.options.workers,this.frames.length),(function(){d=[];for(var w=f=this.freeWorkers.length;f<=o?w<o:w>o;f<=o?w++:w--)d.push(w);return d}).apply(this).forEach(function(w){return function(I){var b;return w.log("spawning worker "+I),b=new Worker(w.options.workerScript),b.onmessage=function(L){return w.activeWorkers.splice(w.activeWorkers.indexOf(b),1),w.freeWorkers.push(b),w.frameFinished(L.data)},w.freeWorkers.push(b)}}(this)),o},y.prototype.frameFinished=function(o){var f,d;if(this.log("frame "+o.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[o.index]=o,this.options.globalPalette===!0&&(this.options.globalPalette=o.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(f=1,d=this.freeWorkers.length;1<=d?f<d:f>d;1<=d?++f:--f)this.renderNextFrame();return a.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},y.prototype.finishRendering=function(){var o,f,d,w,I,b,L,F,$,V,J,A,xe,ue,he,fe;for(F=0,ue=this.imageParts,I=0,$=ue.length;I<$;I++)f=ue[I],F+=(f.data.length-1)*f.pageSize+f.cursor;for(F+=f.pageSize-f.cursor,this.log("rendering finished - filesize "+Math.round(F/1e3)+"kb"),o=new Uint8Array(F),A=0,he=this.imageParts,b=0,V=he.length;b<V;b++)for(f=he[b],fe=f.data,d=L=0,J=fe.length;L<J;d=++L)xe=fe[d],o.set(xe,A),d===f.data.length-1?A+=f.cursor:A+=f.pageSize;return w=new Blob([o],{type:"image/gif"}),this.emit("finished",w,o)},y.prototype.renderNextFrame=function(){var o,f,d;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return o=this.frames[this.nextFrame++],d=this.freeWorkers.shift(),f=this.getTask(o),this.log("starting frame "+(f.index+1)+" of "+this.frames.length),this.activeWorkers.push(d),d.postMessage(f)},y.prototype.getContextData=function(o){return o.getImageData(0,0,this.options.width,this.options.height).data},y.prototype.getImageData=function(o){var f;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),f=this._canvas.getContext("2d"),f.setFill=this.options.background,f.fillRect(0,0,this.options.width,this.options.height),f.drawImage(o,0,0),this.getContextData(f)},y.prototype.getTask=function(o){var f,d;if(f=this.frames.indexOf(o),d={index:f,last:f===this.frames.length-1,delay:o.delay,transparent:o.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:u.name==="chrome"},o.data!=null)d.data=o.data;else if(o.context!=null)d.data=this.getContextData(o.context);else if(o.image!=null)d.data=this.getImageData(o.image);else throw new Error("Invalid frame");return d},y.prototype.log=function(){var o;if(o=1<=arguments.length?c.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,o)},y}(r),i.exports=l},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(De);var Ye=De.exports;const Xe=Je(Ye),Ke=document.getElementById("imageInput"),D=document.getElementById("gifStartSize"),S=document.getElementById("gifEndSize"),oe=document.getElementById("gifFrameCount"),N=document.getElementById("gifAnimationType"),Q=document.getElementById("gifDelay"),ae=document.getElementById("gifLoopPause"),ge=document.getElementById("gifTimingCurve"),le=document.getElementById("gifColorPalette"),ce=document.getElementById("gifColorMode"),Qe=document.getElementById("gifPreview"),Ze=document.querySelector(".gif-preview"),He=Ze.querySelector(".save-gif");document.getElementById("saveFormat");let T=[],O=null;const E=document.getElementById("fullImage"),Z=document.getElementById("screenFull"),H=document.getElementById("screen256"),ee=document.getElementById("screen16"),te=document.getElementById("screenFullBW"),ne=document.getElementById("screen256BW"),re=document.getElementById("screen16BW"),et=E.getContext("2d",{willReadFrequently:!0});Z.getContext("2d",{willReadFrequently:!0});H.getContext("2d",{willReadFrequently:!0});ee.getContext("2d",{willReadFrequently:!0});te.getContext("2d",{willReadFrequently:!0});ne.getContext("2d",{willReadFrequently:!0});re.getContext("2d",{willReadFrequently:!0});var Ce,ke,Re,Le,Fe,Se;const k=[{canvas:Z,buffer:null,overlay:(Ce=Z.parentElement)==null?void 0:Ce.querySelector(".rendering-overlay")},{canvas:H,buffer:null,overlay:(ke=H.parentElement)==null?void 0:ke.querySelector(".rendering-overlay")},{canvas:ee,buffer:null,overlay:(Re=ee.parentElement)==null?void 0:Re.querySelector(".rendering-overlay")},{canvas:te,buffer:null,overlay:(Le=te.parentElement)==null?void 0:Le.querySelector(".rendering-overlay")},{canvas:ne,buffer:null,overlay:(Fe=ne.parentElement)==null?void 0:Fe.querySelector(".rendering-overlay")},{canvas:re,buffer:null,overlay:(Se=re.parentElement)==null?void 0:Se.querySelector(".rendering-overlay")}],ie=document.getElementById("gridSize");let x=parseInt(ie.value),q=null,R=document.querySelector(".selection-box"),j=!1,U=!1,C=null,Me=0,Pe=0,B=0,W=0,G=0,_=null,M=!1,K=!1;const se=[[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]];function tt(){const t=[];for(let e=0;e<32;e++){const n=Math.round(e*255/31);for(let i=0;i<64;i++){const s=Math.round(i*255/63);for(let r=0;r<32;r++){const l=Math.round(r*255/31);t.push([n,s,l])}}}return t}function nt(){const t=[];for(let e=0;e<6;e++)for(let n=0;n<6;n++)for(let i=0;i<6;i++)t.push([Math.round(e*51),Math.round(n*51),Math.round(i*51)]);for(let e=0;e<40;e++){const n=Math.round(e*255/39);t.push([n,n,n])}return t}const me=tt(),pe=nt();function rt(){switch(le.value){case"16bit":return me;case"256":return pe;case"16":return se;default:return se}}function it(t,e,n){return Math.round(.299*t+.587*e+.114*n)}function qe(t,e,n,i,s=!1){if(s&&(t=e=n=it(t,e,n)),i.length===65536){const u=Math.round(t*31/255),g=Math.round(e*63/255),m=Math.round(n*31/255);return u<<11|g<<5|m}let r=1/0,l=0;for(let u=0;u<i.length;u++){const[g,m,a]=i[u],c=Math.sqrt(Math.pow(t-g,2)+Math.pow(e-m,2)+Math.pow(n-a,2));c<r&&(r=c,l=u)}return l}function Ae(t,e,n){const i=ge.value,s=e/n;switch(i){case"linear":return t*(2-s);case"curved":return t*(1+(1-s)*(1-s));default:return t}}function ve(t,e,n){return Math.round(t+(e-t)*n)}function Te(t){const e=E.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}function st(t,e,n){const i=E.width,s=E.height,r=E.getBoundingClientRect().width/i;return t=Math.max(0,Math.min(t,i*r-n)),e=Math.max(0,Math.min(e,s*r-n)),{left:t,top:e}}function de(t,e,n){const{left:i,top:s}=st(t,e,n);R.style.left=`${i}px`,R.style.top=`${s}px`,R.style.width=`${n}px`,R.style.height=`${n}px`}function ot(){if(!q)return;const t=E.getBoundingClientRect(),e=Math.min(t.width,t.height),n=(t.width-e)/2,i=(t.height-e)/2;de(n,i,e)}function at(t){t.classList.add("active")}function be(t){t.classList.remove("active")}async function lt(t,e,n,i,s,r){return new Promise((l,u)=>{at(r);let g=0;const m=8;function a(){if(M){be(r),u(new Error("Processing cancelled"));return}const c=Math.min(g+m,x);for(;g<c;g++)for(let h=0;h<x;h++){const p=(g*x+h)*4,v=t.data[p],y=t.data[p+1],o=t.data[p+2],f=qe(v,y,o,i,s);e.writeChar(h,g," ",{foreground:0,background:f})}g<x?requestAnimationFrame(a):(M||ye(e,n,i),be(r),l())}a()})}function ye(t,e,n,i){const{cells:s}=t.getBufferData(),r=i||x;e.fillStyle="#000",e.fillRect(0,0,e.canvas.width,e.canvas.height);for(let l=0;l<r;l++)if(s[l])for(let u=0;u<r;u++){const g=s[l][u];if(g&&g.attributes&&typeof g.attributes.background=="number"){const m=n[g.attributes.background];m&&(e.fillStyle=`rgb(${m[0]}, ${m[1]}, ${m[2]})`,e.fillRect(u,l,1,1))}}}async function ct(){if(!q)return;const t=E.getBoundingClientRect(),e=E.width/t.width,n=R.getBoundingClientRect(),i={left:(n.left-t.left)*e,top:(n.top-t.top)*e,width:n.width*e,height:n.height*e},s=document.createElement("canvas");s.width=x,s.height=x;const r=s.getContext("2d",{willReadFrequently:!0});r.drawImage(E,i.left,i.top,i.width,i.height,0,0,x,x);const l=r.getImageData(0,0,x,x);for(let u=0;u<k.length&&!M;u++){const g=k[u];if(g.buffer){const m=u%3===0?me:u%3===1?pe:se,a=u>=3;try{await lt(l,g.buffer,g.canvas.getContext("2d",{willReadFrequently:!0}),m,a,g.overlay),u<k.length-1&&!M&&await new Promise(c=>setTimeout(c,100))}catch(c){if(c.message==="Processing cancelled")break;throw c}}}}function ut(){le.value="256",ce.value="bw",ge.value="curved",D.value="4",S.value="128",oe.value="20",N.value="loop",ae.value="2000"}async function ze(){const t=parseInt(D.value),e=parseInt(S.value),n=parseInt(oe.value),i=parseInt(Q.value),s=N.value;T=await Ne(t,e,n),ft(T,i,s)}function ht(t){q=t;const e=t.width/t.height;E.width=800,E.height=Math.round(800/e),et.drawImage(t,0,0,E.width,E.height),ot(),we(),ut(),setTimeout(ze,1500)}function Oe(t){const e=new Image,n=new FileReader;n.onload=i=>{var s;(s=i.target)!=null&&s.result&&(e.src=i.target.result,e.onload=()=>ht(e))},n.readAsDataURL(t)}function we(){_!==null&&(window.clearTimeout(_),_=null),M=!0,_=window.setTimeout(async()=>{if(!K){M=!1,K=!0;try{await ct()}catch(t){t.message!=="Processing cancelled"&&console.error("Processing error:",t)}finally{K=!1,_=null}}},1e3)}function We(){[Z,H,ee,te,ne,re].forEach(t=>{t.width=x,t.height=x}),k[0].buffer=new P(x,x),k[1].buffer=new P(x,x),k[2].buffer=new P(x,x),k[3].buffer=new P(x,x),k[4].buffer=new P(x,x),k[5].buffer=new P(x,x),k.forEach(t=>{t.buffer&&(t.buffer.clear(),t.buffer.setCursorVisible(!1))})}function Ge(){k.forEach((t,e)=>{if(t.buffer){const n=e%3===0?me:e%3===1?pe:se;ye(t.buffer,t.canvas.getContext("2d",{willReadFrequently:!0}),n)}})}async function Ne(t,e,n){const i=rt(),s=ce.value==="bw",r=[],l=document.createElement("canvas");l.width=256,l.height=256;const u=l.getContext("2d",{willReadFrequently:!0});u.imageSmoothingEnabled=!1;const g=E.getBoundingClientRect(),m=E.width/g.width,a=R.getBoundingClientRect(),c={left:(a.left-g.left)*m,top:(a.top-g.top)*m,width:a.width*m,height:a.height*m};for(let h=0;h<n;h++){const p=h/(n-1),v=ve(t,e,p),y=document.createElement("canvas");y.width=v,y.height=v;const o=y.getContext("2d",{willReadFrequently:!0});o.drawImage(E,c.left,c.top,c.width,c.height,0,0,v,v);const f=new P(v,v),d=o.getImageData(0,0,v,v);for(let b=0;b<v;b++)for(let L=0;L<v;L++){const F=(b*v+L)*4,$=d.data[F],V=d.data[F+1],J=d.data[F+2],A=qe($,V,J,i,s);f.writeChar(L,b," ",{foreground:0,background:A})}const w=document.createElement("canvas");w.width=v,w.height=v;const I=w.getContext("2d",{willReadFrequently:!0});ye(f,I,i,v),u.clearRect(0,0,256,256),u.drawImage(w,0,0,256,256),r.push(u.getImageData(0,0,256,256))}return r}function ft(t,e,n){const i=Qe.getContext("2d",{willReadFrequently:!0});let s=!0,r=0,l=0;const u=parseInt(ae.value);O!==null&&window.clearInterval(O),O=window.setInterval(()=>{if(l>0){l--;return}i.putImageData(t[r],0,0);const g=ve(parseInt(D.value),parseInt(S.value),r/(t.length-1)),m=Ae(e,g,parseInt(S.value));n==="once"?(r=(r+1)%t.length,r===0&&(window.clearInterval(O),O=null)):n==="loop"?(r=(r+1)%t.length,r===0&&u>0&&(l=Math.floor(u/m))):n==="bounce"&&(s?(r++,r>=t.length-1&&(s=!1,u>0&&(l=Math.floor(u/m)))):(r--,r<=0&&(s=!0,u>0&&(l=Math.floor(u/m)))))},e)}function Ee(t,e,n,i){const s=new Xe({workers:2,quality:10,width:256,height:256,workerScript:"gif.worker.js",repeat:n==="once"?1:0}),r=document.createElement("canvas");r.width=256,r.height=256;const l=r.getContext("2d",{willReadFrequently:!0}),u=parseInt(ae.value),g=parseInt(D.value),m=parseInt(S.value),a=(c,h)=>{l.putImageData(c,0,0);const p=ve(g,m,h),v=Ae(e,p,m);s.addFrame(r,{delay:v,copy:!0})};if(n==="bounce"){t.forEach((c,h)=>{a(c,h/(t.length-1))}),u>0&&(l.putImageData(t[t.length-1],0,0),s.addFrame(r,{delay:u,copy:!0}));for(let c=t.length-2;c>0;c--)a(t[c],c/(t.length-1));u>0&&(l.putImageData(t[0],0,0),s.addFrame(r,{delay:u,copy:!0}))}else t.forEach((c,h)=>{a(c,h/(t.length-1)),u>0&&h===t.length-1&&(l.putImageData(c,0,0),s.addFrame(r,{delay:u,copy:!0}))});s.on("finished",c=>{const h=URL.createObjectURL(c),p=document.createElement("a");p.download=`${i}.gif`,p.href=h,p.click(),URL.revokeObjectURL(h)}),s.render()}Ke.addEventListener("change",t=>{const e=t.target.files;e&&e[0]&&Oe(e[0])});const X=new URLSearchParams(window.location.search).get("debug")==="true";document.addEventListener("paste",t=>{var n;const e=(n=t.clipboardData)==null?void 0:n.items;if(!e){X&&console.log("No clipboard data items found");return}X&&(console.log("Clipboard items:",Array.from(e).map(i=>({kind:i.kind,type:i.type}))),console.log("Raw clipboard data:",t.clipboardData));for(const i of e)if(X&&console.log("Processing item:",{kind:i.kind,type:i.type}),i.type.indexOf("image")!==-1){const s=i.getAsFile();if(s){X&&console.log("Found image file:",{name:s.name,type:s.type,size:s.size}),Oe(s);break}}});function je(t){if(isNaN(t)||t<=0)return;const e=x;ie.value=t.toString(),parseInt(D.value)===e&&(D.value=t.toString(),z()),parseInt(S.value)===e&&(S.value=t.toString(),z()),M=!0,_!==null&&(window.clearTimeout(_),_=null);const n=async()=>{K&&(await new Promise(i=>setTimeout(i,50)),await n())};n().then(()=>{if(x=t,We(),!k.every(s=>s.buffer&&s.buffer.getBufferData().cells.length===x)){console.error("Buffer initialization failed");return}M=!1,q?we():requestAnimationFrame(()=>Ge())})}ie.addEventListener("change",()=>{je(parseInt(ie.value))});document.querySelectorAll(".grid-size-btn").forEach(t=>{t.addEventListener("click",()=>{const e=parseInt(t.dataset.size||"0");je(e)})});R.addEventListener("mousedown",t=>{if(!q)return;const e=t.target;e.classList.contains("selection-handle")?(U=!0,C=e):j=!0;const n=Te(t);Me=n.x,Pe=n.y,W=parseFloat(R.style.left)||0,G=parseFloat(R.style.top)||0,B=parseFloat(R.style.width)||0,parseFloat(R.style.height),t.preventDefault()});document.addEventListener("mousemove",t=>{if(!q||!j&&!U)return;const e=Te(t),n=e.x-Me,i=e.y-Pe;if(j)de(W+n,G+i,B);else if(U){let s=B,r=W,l=G;if(C!=null&&C.classList.contains("se"))s=Math.max(B+n,B+i);else if(C!=null&&C.classList.contains("sw")){const u=Math.max(-n,i);s=B+u,r=W-u}else if(C!=null&&C.classList.contains("ne")){const u=Math.max(n,-i);s=B+u,l=G-u}else if(C!=null&&C.classList.contains("nw")){const u=Math.max(-n,-i);s=B+u,r=W-u,l=G-u}de(r,l,s)}});document.addEventListener("mouseup",()=>{(j||U)&&(j=!1,U=!1,C=null,we(),setTimeout(z,250))});He.addEventListener("click",()=>{const t=document.querySelector(".save-dialog"),e=document.getElementById("saveFormat"),n=document.getElementById("saveFilename");e.value="gif",e.disabled=!0,n.value="pixel-animation",t.style.display="flex"});var Be;(Be=document.querySelector(".save-ok"))==null||Be.addEventListener("click",async()=>{const t=document.querySelector(".save-dialog"),e=document.getElementById("saveFormat"),n=document.getElementById("saveFilename").value,i=e.value.toUpperCase();if(t.saveData===void 0)if(T.length===0){const s=parseInt(D.value),r=parseInt(S.value),l=parseInt(oe.value),u=parseInt(Q.value),g=N.value;T=await Ne(s,r,l),Ee(T,u,g,n)}else{const s=parseInt(Q.value),r=N.value;Ee(T,s,r,n)}else{const{canvas:s}=t.saveData,r=document.createElement("a");r.download=`${n}.${i.toLowerCase()}`;const l=i==="JPG"?"jpeg":i.toLowerCase();r.href=s.toDataURL(`image/${l}`),r.click(),t.saveData=void 0}t.style.display="none",e.disabled=!1});var _e;(_e=document.querySelector(".save-cancel"))==null||_e.addEventListener("click",()=>{const t=document.querySelector(".save-dialog"),e=document.getElementById("saveFormat");t.style.display="none",e.disabled=!1});const z=()=>{q&&ze()};[D,S,oe].forEach(t=>{t.addEventListener("input",z)});[N,Q,ae,ge,le,ce].forEach(t=>{t.addEventListener("change",z)});function Ie(t,e){const n=document.querySelector(".save-dialog"),i=document.getElementById("saveFormat"),s=document.getElementById("saveFilename");n.saveData={canvas:t},i.value=e==="JPEG"?"jpg":e.toLowerCase(),i.disabled=!1,s.value="pixel-image",n.style.display="flex"}document.querySelectorAll(".action-overlay").forEach(t=>{const e=t.querySelector(".set-gif");e&&e.addEventListener("click",()=>{const r=t.dataset.palette,l=t.dataset.mode;r&&l&&(le.value=r,ce.value=l,z())});const n=t.querySelector(".png"),i=t.querySelector(".jpg"),s=t.closest(".screen-container");if(s){const r=s.querySelector("canvas");r&&(n&&n.addEventListener("click",()=>Ie(r,"PNG")),i&&i.addEventListener("click",()=>Ie(r,"JPEG")))}});We();Ge();
